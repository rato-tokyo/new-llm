# UltraChat Training Guide

å¤§è¦æ¨¡å¤šæ§˜å¯¾è©±ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆUltraChatï¼‰ã§ã®è¨“ç·´ã‚¬ã‚¤ãƒ‰

---

## ğŸ“Š UltraChatã¨ã¯

**GPT-3.5ç”Ÿæˆã®è¶…å¤§è¦æ¨¡å¯¾è©±ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ**

| ç‰¹å¾´ | è©³ç´° |
|-----|------|
| **ãƒ‡ãƒ¼ã‚¿é‡** | 1,500,000ä»¶ä»¥ä¸Šï¼ˆHH-RLHFã®**18å€**ï¼‰ |
| **å½¢å¼** | è¤‡æ•°ã‚¿ãƒ¼ãƒ³å¯¾è©±ï¼ˆMulti-turnï¼‰ |
| **è¨€èª** | è‹±èªã®ã¿ |
| **ãƒˆãƒ”ãƒƒã‚¯** | ç§‘å­¦ã€æŠ€è¡“ã€æ­´å²ã€æ–‡åŒ–ã€å“²å­¦ãªã©**éå¸¸ã«å¤šæ§˜** |
| **ç”Ÿæˆæ–¹æ³•** | GPT-3.5ã§ç”Ÿæˆï¼ˆé«˜ã„å¤šæ§˜æ€§ï¼‰ |

---

## ğŸ¯ HH-RLHFã¨ã®æ¯”è¼ƒ

| é …ç›® | HH-RLHF | UltraChat |
|-----|---------|-----------|
| **ãƒ‡ãƒ¼ã‚¿é‡** | 85,000 | **1,500,000ï¼ˆ18å€ï¼‰** |
| **ãƒˆãƒ”ãƒƒã‚¯å¤šæ§˜æ€§** | æ¨™æº– | **éå¸¸ã«é«˜ã„** |
| **è¨“ç·´æ™‚é–“** | 20-30åˆ† | **2-3æ™‚é–“ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰** |
| **æœŸå¾…PPL** | 17-20 | **20-25** |
| **é›£æ˜“åº¦** | â˜…â˜…â˜†â˜†â˜† | **â˜…â˜…â˜…â˜†â˜†** |

**UltraChatã®æ–¹ãŒé›£ã—ã„**ãŒã€ã‚ˆã‚Šå¤šæ§˜ãªå¯¾è©±èƒ½åŠ›ã‚’ç²å¾—ã§ãã¾ã™ã€‚

---

## ğŸš€ Google Colabã§ã®å®Ÿè¡Œæ–¹æ³•

### ğŸ¯ æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ï¼š1è¡Œã‚³ãƒãƒ³ãƒ‰ï¼ˆæ¨å¥¨ï¼‰

**Layer 1ã€ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ1.5Mä»¶ã€2.5-3.5æ™‚é–“ï¼‰**:
```bash
!curl -s https://raw.githubusercontent.com/rato-tokyo/new-llm/main/scripts/colab_train_ultrachat.sh | bash
```

**Layer 4ã€ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆã‚ˆã‚Šé«˜æ€§èƒ½ï¼‰**:
```bash
!curl -s https://raw.githubusercontent.com/rato-tokyo/new-llm/main/scripts/colab_train_ultrachat.sh | bash -s -- --num_layers 4
```

**Layer 4ã€ã‚µãƒ–ã‚»ãƒƒãƒˆ10ä¸‡ä»¶ï¼ˆ20-40åˆ†ã€å‹•ä½œç¢ºèªç”¨ï¼‰**:
```bash
!curl -s https://raw.githubusercontent.com/rato-tokyo/new-llm/main/scripts/colab_train_ultrachat.sh | bash -s -- --num_layers 4 --max_samples 100000
```

**ã“ã‚Œã ã‘ã§å…¨è‡ªå‹•ã§è¨“ç·´ãŒé–‹å§‹ã•ã‚Œã¾ã™ï¼**

---

### ğŸ“‹ è©³ç´°ãªæ‰‹é †ï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„å ´åˆã®ã¿ï¼‰

#### âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¦æ¨¡ã«ã¤ã„ã¦

UltraChatã¯**1.5Mä»¶**ã¨éå¸¸ã«å¤§è¦æ¨¡ã§ã™ã€‚ä»¥ä¸‹ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ï¼š

1. **ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ1.5Mä»¶ï¼‰**: 2-3æ™‚é–“ã®è¨“ç·´æ™‚é–“
2. **ã‚µãƒ–ã‚»ãƒƒãƒˆï¼ˆ10ä¸‡ä»¶ãªã©ï¼‰**: 20-40åˆ†ã®è¨“ç·´æ™‚é–“ï¼ˆæ¨å¥¨ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# GPUç¢ºèª
!nvidia-smi

# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
%cd /content
!rm -rf new-llm
!git clone https://github.com/rato-tokyo/new-llm
%cd new-llm

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
!pip install -q datasets tqdm
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: UltraChatè¨“ç·´é–‹å§‹

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: ã‚µãƒ–ã‚»ãƒƒãƒˆè¨“ç·´ï¼ˆæ¨å¥¨ã€20-40åˆ†ï¼‰**

```bash
# Layer 1ï¼ˆ10ä¸‡ä»¶ã‚µãƒ³ãƒ—ãƒ«ï¼‰
!nohup python scripts/train_ultrachat.py --num_layers 1 --max_samples 100000 > /content/ultrachat_layer1_100k.log 2>&1 &

# 10ç§’å¾…æ©Ÿã—ã¦ãƒ­ã‚°ç¢ºèª
!sleep 10 && tail -30 /content/ultrachat_layer1_100k.log
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¨“ç·´ï¼ˆ2-3æ™‚é–“ï¼‰**

```bash
# Layer 1ï¼ˆå…¨1.5Mä»¶ï¼‰
!nohup python scripts/train_ultrachat.py --num_layers 1 > /content/ultrachat_layer1_full.log 2>&1 &

# 10ç§’å¾…æ©Ÿã—ã¦ãƒ­ã‚°ç¢ºèª
!sleep 10 && tail -30 /content/ultrachat_layer1_full.log
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³C: Layer 4ã§è¨“ç·´ï¼ˆã‚ˆã‚Šé«˜æ€§èƒ½ï¼‰**

```bash
# Layer 4ï¼ˆ10ä¸‡ä»¶ã‚µãƒ³ãƒ—ãƒ«ï¼‰
!nohup python scripts/train_ultrachat.py --num_layers 4 --max_samples 100000 > /content/ultrachat_layer4_100k.log 2>&1 &

# 10ç§’å¾…æ©Ÿã—ã¦ãƒ­ã‚°ç¢ºèª
!sleep 10 && tail -30 /content/ultrachat_layer4_100k.log
```

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹çµæœ

### ã‚µãƒ–ã‚»ãƒƒãƒˆï¼ˆ10ä¸‡ä»¶ï¼‰

| æŒ‡æ¨™ | Layer 1 | Layer 4 |
|-----|---------|---------|
| **Val PPL** | **20-23** | **18-21** |
| **Val Acc** | **41-43%** | **43-45%** |
| **è¨“ç·´æ™‚é–“** | 20-30åˆ† | 30-40åˆ† |

### ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ1.5Mä»¶ï¼‰

| æŒ‡æ¨™ | Layer 1 | Layer 4 |
|-----|---------|---------|
| **Val PPL** | **18-21** | **16-19** |
| **Val Acc** | **43-45%** | **45-47%** |
| **è¨“ç·´æ™‚é–“** | 2-3æ™‚é–“ | 3-4æ™‚é–“ |

**HH-RLHFã¨ã®æ¯”è¼ƒ**:
- HH-RLHF Layer 1: PPL 17-20
- UltraChat Layer 1: PPL 20-23ï¼ˆ+3ãƒã‚¤ãƒ³ãƒˆé›£ã—ã„ï¼‰
- UltraChat Full Layer 4: PPL 16-19ï¼ˆæœ€é«˜æ€§èƒ½ï¼‰

---

## âš™ï¸ è¨­å®š

### è‡ªå‹•è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å€¤ | ç†ç”± |
|-----------|-----|------|
| **batch_size** | 2048 | L4 GPUæœ€é©åŒ– |
| **learning_rate** | 0.0008 | Square Root Scaling |
| **max_seq_length** | 128 | è¤‡æ•°ã‚¿ãƒ¼ãƒ³å¯¾è©±ç”¨ |
| **epochs** | 50 | å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”¨ï¼ˆå°‘ãªã‚ï¼‰ |
| **context_dim** | 256 | æ¨™æº– |

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```bash
# ã‚ˆã‚Šé•·ã„ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
python scripts/train_ultrachat.py --num_layers 4 --max_seq_length 256

# ã‚¨ãƒãƒƒã‚¯æ•°èª¿æ•´
python scripts/train_ultrachat.py --num_layers 4 --max_samples 100000 --epochs 100

# å°è¦æ¨¡ãƒ†ã‚¹ãƒˆï¼ˆ1ä¸‡ä»¶ï¼‰
python scripts/train_ultrachat.py --num_layers 1 --max_samples 10000
```

---

## ğŸ” é€²æ—ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤º

```bash
# æœ€æ–°20è¡Œ
!tail -20 /content/ultrachat_layer1_100k.log

# ç¶™ç¶šçš„ãªç›£è¦–
!tail -f /content/ultrachat_layer1_100k.log
```

### âœ“ãƒãƒ¼ã‚¯ã®æ„å‘³

```
Epoch 25/50
  Training... 100% | 1.2min | Loss: 2.95
  Val: Loss=2.91 PPL=18.4 Acc=44.2% âœ“
  [Checkpoint saved]
  â†‘
  âœ“ = ã“ã®EpochãŒãƒ™ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«
```

### GPUä½¿ç”¨çŠ¶æ³

```bash
!nvidia-smi
```

---

## ğŸ“Š çµæœã®è§£é‡ˆ

### æˆåŠŸã®æŒ‡æ¨™

| PPLç¯„å›² | è©•ä¾¡ | æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— |
|---------|------|-------------|
| **< 19** | ğŸ† **å„ªç§€** | Level 4ï¼ˆCodeAlpacaï¼‰ã¸ |\
| **19-24** | âœ… **æˆåŠŸ** | ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§å†æŒ‘æˆ¦ or Level 4ã¸ |
| **> 24** | âš ï¸ **è¦æ”¹å–„** | ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚’å¢—ã‚„ã™ or Layerå¢—ã‚„ã™ |

### HH-RLHFã¨ã®æ¯”è¼ƒ

**æœŸå¾…ã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³**:
```
HH-RLHF (85k): PPL 17-20 â† é«˜å“è³ªã ãŒé™å®šçš„
UltraChat (100k): PPL 20-23 â† å¤šæ§˜æ€§ã§é›£ã—ã„
UltraChat (1.5M): PPL 18-21 â† å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§æ”¹å–„
```

**ã“ã‚Œã¯æ­£å¸¸ã§ã™ï¼** UltraChatã¯ã‚ˆã‚Šå¤šæ§˜ã§é›£ã—ã„ã‚¿ã‚¹ã‚¯ã§ã™ã€‚

---

## ğŸ¯ ä½•ã‚’å­¦ç¿’ã™ã‚‹ã‹

### HH-RLHFã§å­¦ã‚“ã ã“ã¨

- é«˜å“è³ªãªè¤‡æ•°ã‚¿ãƒ¼ãƒ³å¯¾è©±
- äººé–“ãŒå¥½ã‚€å¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³
- å®‰å…¨æ€§ï¼ˆæœ‰å®³å¿œç­”ã®å›é¿ï¼‰

### UltraChatã§å­¦ã¶ã“ã¨

- **è¶…å¤šæ§˜ãªãƒˆãƒ”ãƒƒã‚¯**: ç§‘å­¦ã€æŠ€è¡“ã€æ­´å²ã€æ–‡åŒ–ã€å“²å­¦ãªã©
- **æ§˜ã€…ãªä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«**: GPT-3.5ãŒç”Ÿæˆã—ãŸå¤šæ§˜ãªãƒ‘ã‚¿ãƒ¼ãƒ³
- **å®Ÿè·µçš„ãªå¯¾è©±èƒ½åŠ›**: æ§˜ã€…ãªå ´é¢ã§ã®å¯¾è©±å¯¾å¿œ
- **å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®å­¦ç¿’**: 1.5Mä»¶ã®è±Šå¯ŒãªçŸ¥è­˜

---

## âš¡ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### GPU Out of Memory

```bash
# batch_sizeã‚’æ¸›ã‚‰ã™
# src/utils/config.pyã®NewLLML4Configã‚’ç·¨é›†
batch_size = 1024  # 2048 â†’ 1024
```

### è¨“ç·´ãŒé…ã„

```bash
# ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚’æ¸›ã‚‰ã™
python scripts/train_ultrachat.py --num_layers 1 --max_samples 50000

# Layeræ•°ã‚’æ¸›ã‚‰ã™
python scripts/train_ultrachat.py --num_layers 1  # 4 â†’ 1
```

### PPLãŒä¸‹ãŒã‚‰ãªã„

1. **ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚’å¢—ã‚„ã™**: 10ä¸‡ â†’ 50ä¸‡
2. **Epochã‚’å¢—ã‚„ã™**: 50 â†’ 100
3. **Layer 4ã§è©¦ã™**: ã‚ˆã‚Šæ·±ã„ãƒ¢ãƒ‡ãƒ«
4. **ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ**: 1.5Må…¨ä»¶ã§è¨“ç·´

---

## ğŸ“ ä¿å­˜ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| `checkpoints/best_new_llm_ultrachat_layers1.pt` | ãƒ™ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ« |
| `new_llm_ultrachat_layers1_final.pt` | æœ€çµ‚Epoch |
| `/content/ultrachat_layer1_100k.log` | è¨“ç·´ãƒ­ã‚° |

---

## ğŸš€ è¨“ç·´å®Œäº†å¾Œ

### çµæœã®ä¿å­˜

```bash
# Colabã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
from google.colab import files
files.download('/content/new-llm/checkpoints/best_new_llm_ultrachat_layers1.pt')
files.download('/content/ultrachat_layer1_100k.log')
```

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**æˆåŠŸã—ãŸã‚‰ï¼ˆPPL < 24ï¼‰**:

1. **ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ**: 1.5Mä»¶ã§å†è¨“ç·´ï¼ˆã•ã‚‰ã«æ€§èƒ½å‘ä¸Šï¼‰
2. **Layer 4ã§è©¦ã™**: ã‚ˆã‚Šé«˜æ€§èƒ½
3. **Level 4ã¸é€²ã‚€**: CodeAlpacaï¼ˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆèƒ½åŠ›ï¼‰
4. **Context Expansion**: 256â†’512æ¬¡å…ƒï¼ˆã‚ˆã‚Šé•·ã„æ–‡è„ˆï¼‰

**å¯¾è©±èƒ½åŠ›ã®å®Œæˆï¼**: UltraChatã§æˆåŠŸã™ã‚Œã°ã€æ™®é€šã«å¯¾è©±ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã«åˆ°é”

---

## ğŸ“– é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `TRAINING_PROGRESSION.md` - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆé›£æ˜“åº¦é †
- `HH_RLHF_TRAINING.md` - HH-RLHFè¨“ç·´ã‚¬ã‚¤ãƒ‰
- `experiments/dolly_dialog_experiment_2025-11-19.md` - Dollyçµæœ
- `ARCHITECTURE.md` - New-LLMã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

---

## ğŸ’¡ æ¨å¥¨ã•ã‚Œã‚‹è¨“ç·´æˆ¦ç•¥

### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µãƒ–ã‚»ãƒƒãƒˆã§è©¦ã™ï¼ˆæ¨å¥¨ï¼‰

```bash
# ã¾ãš10ä¸‡ä»¶ã§è©¦ã—ã¦ã€å‹•ä½œç¢ºèªãƒ»æ€§èƒ½è©•ä¾¡
python scripts/train_ultrachat.py --num_layers 4 --max_samples 100000
```

**åˆ©ç‚¹**:
- âœ… 20-40åˆ†ã§å®Œäº†ï¼ˆColab 90åˆ†åˆ¶é™å†…ï¼‰
- âœ… å‹•ä½œç¢ºèªã¨ãƒ‡ãƒãƒƒã‚°ãŒæ—©ã„
- âœ… æ€§èƒ½ã®è¦‹é€šã—ãŒç«‹ã¤

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆæˆåŠŸå¾Œï¼‰

```bash
# ã‚µãƒ–ã‚»ãƒƒãƒˆã§è‰¯å¥½ãªçµæœãªã‚‰ã€ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è¨“ç·´
python scripts/train_ultrachat.py --num_layers 4
```

**åˆ©ç‚¹**:
- âœ… æœ€é«˜æ€§èƒ½ã‚’ç²å¾—
- âœ… ã‚ˆã‚Šå¤šæ§˜ãªå¯¾è©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’

---

**æº–å‚™å®Œäº†ï¼** UltraChatè¨“ç·´ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚

**æ¨å¥¨é–‹å§‹ã‚³ãƒãƒ³ãƒ‰**:
```bash
# ã‚µãƒ–ã‚»ãƒƒãƒˆï¼ˆ10ä¸‡ä»¶ï¼‰ã§é–‹å§‹
python scripts/train_ultrachat.py --num_layers 4 --max_samples 100000
```
