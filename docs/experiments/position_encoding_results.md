# Position Encoding Experiment Results

位置エンコーディングの比較実験結果。

---

## 10,000サンプル実験 - 2025-12-05

RoPE (2D), RoPE3D (3D), Learnable (K only) の比較実験。

### 実験設定

| 項目 | 値 |
|------|-----|
| Device | NVIDIA L4 (23.8GB VRAM) |
| Samples | 10,000 |
| Sequence Length | 128 |
| Epochs | 30 (early stopping, patience=3) |
| Learning Rate | 1e-4 |
| Model | UnifiedPythiaModel (70.4M params) |
| Train samples | 9,330 (Pile: 9,000 + Reversal: 330) |
| Val samples | 1,000 (Pile only, データリークなし) |

### 結果サマリー

| Position Encoding | Best PPL | Best Epoch | RoPE比 | 速度 |
|-------------------|----------|------------|--------|------|
| **RoPE (2D)** | **90.3** | 5 | baseline | 86s/epoch |
| RoPE3D (3D) | 90.7 | 5 | +0.4% | 87s/epoch |
| Learnable (K only) | 106.0 | 5 | +17.4% | 532s/epoch |

### 学習曲線

**RoPE (2D) - Baseline**
```
Epoch  1: train_ppl=512.1 val_ppl=278.7 *
Epoch  2: train_ppl=136.3 val_ppl=157.3 *
Epoch  3: train_ppl=72.1  val_ppl=115.4 *
Epoch  4: train_ppl=43.7  val_ppl=98.1 *
Epoch  5: train_ppl=27.8  val_ppl=90.3 * (best)
Epoch  6: train_ppl=17.9  val_ppl=91.2
-> Early stop
```

**RoPE3D (3D)**
```
Epoch  1: train_ppl=518.0 val_ppl=283.7 *
Epoch  2: train_ppl=138.7 val_ppl=159.8 *
Epoch  3: train_ppl=73.5  val_ppl=117.2 *
Epoch  4: train_ppl=44.5  val_ppl=99.2 *
Epoch  5: train_ppl=28.4  val_ppl=90.7 * (best)
Epoch  6: train_ppl=18.3  val_ppl=91.4
-> Early stop
```

**Learnable (K only)**
```
Epoch  1: train_ppl=529.0 val_ppl=301.9 *
Epoch  2: train_ppl=150.6 val_ppl=178.5 *
Epoch  3: train_ppl=82.8  val_ppl=132.9 *
Epoch  4: train_ppl=51.0  val_ppl=113.7 *
Epoch  5: train_ppl=32.5  val_ppl=106.0 * (best)
Epoch  6: train_ppl=20.9  val_ppl=109.0
-> Early stop
```

### 学習曲線の比較

| Epoch | RoPE val_ppl | RoPE3D val_ppl | Learnable val_ppl |
|-------|--------------|----------------|-------------------|
| 1 | 278.7 | 283.7 | 301.9 |
| 2 | 157.3 | 159.8 | 178.5 |
| 3 | 115.4 | 117.2 | 132.9 |
| 4 | 98.1 | 99.2 | 113.7 |
| 5 | **90.3** | **90.7** | 106.0 |

### Position-wise PPL

| Position | RoPE (2D) | RoPE3D (3D) | Learnable |
|----------|-----------|-------------|-----------|
| 0-16 | 148.2 | 147.7 | 177.3 |
| 16-32 | 89.0 | 88.7 | 110.6 |
| 32-64 | 85.2 | 85.7 | 101.8 |
| 64-96 | 86.8 | 86.7 | 101.0 |
| 96-128 | 81.7 | 82.1 | 98.0 |

### Reversal Curse評価

| Model | Forward PPL | Backward PPL | Ratio | Gap |
|-------|-------------|--------------|-------|-----|
| RoPE (2D) | 1.7 | 637.9 | 0.003 | +636.2 |
| RoPE3D (3D) | 1.7 | 805.6 | 0.002 | +803.9 |
| Learnable | 1.7 | 637.4 | 0.003 | +635.7 |

### パラメータ数

| Model | Parameters | 追加パラメータ |
|-------|------------|---------------|
| RoPE (2D) | 70,420,480 | 0 (固定回転行列) |
| RoPE3D (3D) | 70,420,480 | 0 (固定回転行列) |
| Learnable | 70,424,704 | +4,224 (遷移行列 64x64 + LayerNorm) |

---

## 考察

### RoPE (2D) vs RoPE3D (3D) 詳細比較

#### 設計の違い

| 項目 | RoPE (2D) | RoPE3D (3D) |
|------|-----------|-------------|
| 回転次元 | 2次元ペア | 3次元グループ |
| 回転軸 | 各ペアで独立 | (1,1,1)/√3 の斜め軸 |
| 回転公式 | 2x2回転行列 | ロドリゲスの公式 |
| 更新される次元 | 2次元/グループ | 3次元/グループ |
| rotary_dim | 16 (25% of 64) | 15 (3の倍数に調整) |

#### 実装の違い

```
RoPE (2D):
  [x1, x2] -> [x1*cos - x2*sin, x1*sin + x2*cos]

RoPE3D (3D):
  [x1, x2, x3] -> R(θ) @ [x1, x2, x3]
  R(θ) = I + sin(θ)*K + (1-cos(θ))*K²  (ロドリゲス)
```

#### 性能比較

| 指標 | RoPE (2D) | RoPE3D (3D) | 差異 | 勝者 |
|------|-----------|-------------|------|------|
| Best PPL | 90.3 | 90.7 | +0.4% | RoPE |
| 収束epoch | 5 | 5 | 同じ | - |
| 速度 | 86s | 87s | +1.2% | RoPE |
| Backward PPL | 637.9 | 805.6 | +26.3% | RoPE |
| Position 0-16 PPL | 148.2 | 147.7 | -0.3% | RoPE3D |
| Position 96-128 PPL | 81.7 | 82.1 | +0.5% | RoPE |

#### 周波数分布の問題

```
RoPE 2D (8ペア):
  pair 0: freq=1.000000  (高周波 - 近距離)
  pair 1: freq=0.316228
  pair 2: freq=0.100000
  pair 3: freq=0.031623
  pair 4: freq=0.010000
  pair 5: freq=0.003162
  pair 6: freq=0.001000
  pair 7: freq=0.000316  (低周波 - 長距離)

RoPE3D (5グループ):
  group 0: freq=1.000000  (高周波)
  group 1: freq=0.158489
  group 2: freq=0.025119
  group 3: freq=0.003981
  group 4: freq=0.000631  (低周波)
```

**問題点**:
- RoPE 3D は **グループ数が少ない**（5 vs 8）
- 周波数の **中間帯域が不足**（0.1〜0.01の範囲が粗い）
- 各グループは3次元を同時に回転させるため、**独立性が低い**

#### 結論

**RoPE3D は RoPE (2D) に対して利点がない。**

1. **PPLはほぼ同等**: 差は0.4%（統計的に有意でない）
2. **Reversal Curse が悪化**: Backward PPL が26%高い（805.6 vs 637.9）
3. **周波数表現力の低下**:
   - グループ数が少ない（5 vs 8）
   - 中間周波数帯域の表現力不足
4. **3D回転の問題**:
   - 斜め軸(1,1,1)の回転は3次元すべてを同時に更新
   - 次元間の独立性が低下し、方向依存性が強まる

### RoPE vs Learnable

| 項目 | RoPE (2D) | Learnable | 差異 |
|------|-----------|-----------|------|
| Epoch 5 val_ppl | 90.3 | 106.0 | +17.4% |
| 速度 | 86s | 532s | 6.2x 遅い |
| 追加パラメータ | 0 | +4,224 | +0.006% |

**結論**: Learnable は RoPE より約17%劣化。また、速度が6倍以上遅い。学習可能な行列の累積適用は、固定の回転行列より効果的ではない。パラメータ増加はわずか(+0.006%)だが、それでも性能悪化。

### 総合評価

| 位置エンコーディング | PPL | Backward PPL | 速度 | 推奨度 |
|---------------------|-----|--------------|------|--------|
| **RoPE (2D)** | 90.3 | 637.9 | 速い | ★★★ 推奨 |
| Learnable (K only) | 106.0 | 637.4 | 遅い | ★★ Reversal Curseは同等 |
| RoPE3D (3D) | 90.7 | 805.6 | 速い | ★ Reversal Curse悪化 |

### 発見

1. **RoPE (2D) が最良**: シンプルな2D回転が最も効果的
2. **RoPE3D は利点なし**: 3D回転による改善は見られず、Reversal Curse が悪化
3. **Learnable は興味深い結果**:
   - PPLは17%劣化するが、**Reversal Curse は RoPE と同等**（637.4 vs 637.9）
   - 学習可能な行列でもReversal Curseを軽減できていない
4. **位置エンコーディングの設計**: 固定の回転行列（RoPE）が学習可能な行列より優れている

### なぜ RoPE3D は Reversal Curse が悪化したか？

**仮説**: 3D回転は「方向性」がより強い

1. **次元間の結合**: 2D回転は各ペアが独立だが、3D回転は3次元が同時に変化
2. **周波数の粗さ**: グループ数が少ない（5 vs 8）ため、位置の区別がより「離散的」
3. **回転軸の統一**: 斜め軸(1,1,1)で全グループが回転するため、位置パターンが均一化

結果として、「A is B」と「B is A」の表現がより区別されやすくなり、逆方向への汎化が困難になった。

### なぜ Learnable は Reversal Curse が同等だったか？

Learnable は Kにのみ適用し、Qはそのまま。これは RoPE（Q, K両方に適用）とは異なる。
しかし、結果的に Reversal Curse は同等だった。

**考察**:
- Reversal Curse は位置エンコーディングの「方式」ではなく、「存在」に起因
- 位置情報があること自体が方向依存性を生む
- NoPE（位置情報なし）のBackward PPLが最も低い（644.7）のはこれを支持

---

## Position-wise PPL の詳細分析

### 距離別の勝敗

| Position | RoPE (2D) | RoPE3D (3D) | 差異 | 勝者 |
|----------|-----------|-------------|------|------|
| 0-16 | 148.2 | **147.7** | -0.3% | **3D** |
| 16-32 | 89.0 | **88.7** | -0.3% | **3D** |
| 32-64 | **85.2** | 85.7 | +0.6% | 2D |
| 64-96 | 86.8 | **86.7** | -0.1% | **3D** |
| 96-128 | **81.7** | 82.1 | +0.5% | 2D |

**観察**: 近距離（0-32）で3Dが優位、遠距離（96-128）で2Dが優位

### なぜ3D回転は近距離で強いか？

**1. 高周波グループの次元数の違い**

```
RoPE 2D: pair 0 (freq=1.0) → 2次元を更新
RoPE 3D: group 0 (freq=1.0) → 3次元を更新
```

3D回転は**高周波グループで3次元を同時に回転**させる。近距離（position 0-32）では高周波成分が重要であり、3次元を同時に更新することで**近距離の微細な位置差をより豊かに表現**できる可能性がある。

**2. 回転の滑らかさ**

```
2D回転: 2次元平面上の円運動
        position差1 → 角度θだけ回転

3D回転: 3次元空間での回転（斜め軸周り）
        position差1 → 3次元すべてが連動して変化
```

3D回転は**隣接位置間の変化がより滑らか**になる可能性がある。2Dでは各ペアが独立に回転するが、3Dでは3次元が協調して回転するため、小さなposition差でも表現が豊かになる。

### なぜ遠距離（96-128）では2Dが強いか？

**低周波グループ数の差**

```
RoPE 2D: 8ペア → 低周波側に多くのペア
  pair 5: freq=0.003162
  pair 6: freq=0.001000
  pair 7: freq=0.000316

RoPE 3D: 5グループ → 低周波側が少ない
  group 3: freq=0.003981
  group 4: freq=0.000631
```

2Dは**低周波帯域の解像度が高い**ため、遠距離の位置関係をより細かく区別できる。

### 距離特性のまとめ

| 距離 | 勝者 | 理由 |
|------|------|------|
| 近距離（0-32） | **3D** | 高周波グループが3次元 → 近距離の表現力↑ |
| 遠距離（96-128） | **2D** | 低周波グループが多い → 遠距離の区別力↑ |

---

## 関連研究: Massive Values in Self-Attention

### 研究概要

[Massive Values in Self-Attention Modules are the Key to Contextual Knowledge Understanding](https://arxiv.org/abs/2502.01563) (2025)

この研究は、LLMのAttentionにおけるQ, Kベクトルの**低周波領域にMassive Values（巨大値）が集中**することを発見した。

### 主要な発見

1. **Massive ValuesがQ, Kの低周波領域に集中**
   - RoPEの周波数: `θⱼ = 10000^(-2j/d)`
   - 低周波領域（後半の次元ペア）は位置情報の影響が少ない
   - その結果、**文脈知識（contextual knowledge）** がここに蓄積される

2. **低周波 ≒ 文脈理解、高周波 ≒ 位置情報**
   - 低周波成分は位置変化に対してゆっくり回転 → 長距離関係を捉える
   - 高周波成分は高速に回転 → 近距離の位置を区別

3. **Massive Valuesの重要性**
   - これを破壊すると文脈理解タスク（IMDB、GSM8K）が崩壊
   - 一方、パラメトリック知識（世界知識）は15-20%の劣化のみ

### 本実験との関連

**研究の予測**: 低周波領域が文脈理解に重要

**実験結果との整合性**:

| 観点 | RoPE 2D | RoPE 3D | 研究との整合 |
|------|---------|---------|-------------|
| PPL（文脈理解） | 90.3 | 90.7 | ほぼ同等 → 低周波の機能は維持 |
| 低周波グループ数 | 8 | 5 | 3Dは低周波帯域の解像度低下 |
| 遠距離PPL | 81.7 | 82.1 | 2Dが優位 → 低周波の重要性を支持 |
| 近距離PPL | 148.2 | 147.7 | 3Dが優位 → 高周波の表現力向上 |

**考察**:
- PPLの微差（+0.4%）は、3D回転でも低周波グループの機能が維持されていることを示す
- 遠距離で2Dが優位なのは、低周波グループ数の差（8 vs 5）が効いている
- 近距離で3Dが優位なのは、高周波グループの3次元表現力が効いている

### Reversal Curseとの関連

研究によると、Massive Valuesは**文脈理解**に重要だが、Reversal Curseは**方向依存性**の問題。

| 指標 | 文脈理解 | Reversal Curse |
|------|---------|----------------|
| 関連する周波数 | 低周波（Massive Values） | 全周波数 |
| 2D vs 3D | ほぼ同等 | 3Dが26%悪化 |
| 原因 | - | 3D回転の方向依存性 |

**示唆**: 3D回転の問題は低周波の文脈理解ではなく、**位置エンコーディング全体の方向性**にある。

### 今後の検証可能な方向

1. **ハイブリッド方式**: 高周波は3D、低周波は2D
2. **グループ数の統一**: 2Dで5ペア vs 3Dで5グループの比較
3. **異なる回転軸**: 斜め軸(1,1,1)ではなく標準軸での3D回転

---

## 訓練済みPythia-70m Q, K統計 - 2025-12-05

### 目的

HuggingFaceの訓練済みPythia-70mでQ, K統計を測定し、Massive Valuesの存在を確認する。
**学習なしで既存パラメータのまま測定**。

### 実験設定

- モデル: EleutherAI/pythia-70m（訓練済み）
- サンプル: 5,000
- シーケンス長: 128
- **rotary_pct = 0.25**（16次元にRoPE適用、48次元パススルー）
- **rope_base = 10000**

### 結果

**全体統計**:
```
PPL: 24.4
Overall Q: max=1298.74, mean=40.49, std=63.51
Overall K: max=67.72, mean=18.58, std=22.93
```

**レイヤー別統計**:

| Layer | Q max | Q mean | Q std | K max | K mean | K std |
|-------|-------|--------|-------|-------|--------|-------|
| 0 | 11.27 | 1.07 | 1.60 | 22.77 | 2.50 | 3.71 |
| 1 | 16.38 | 1.04 | 1.57 | 34.31 | 4.32 | 6.23 |
| 2 | 12.09 | 0.96 | 1.46 | 41.97 | 5.49 | 8.09 |
| 3 | **440.74** | 15.26 | 32.05 | **67.72** | 24.78 | 34.84 |
| 4 | **1298.74** | 94.08 | 148.39 | 64.75 | 31.86 | 37.18 |
| 5 | **1261.08** | 130.52 | 196.02 | 66.91 | 42.52 | 47.53 |

**周波数帯域別分析**:
```
Frequency band analysis (rotary_dim=16, head_dim=64):
  RoPE applied: dims 0-15
    High-freq (dims 0-7):  Q=40.35, K=53.74
    Low-freq (dims 8-15):  Q=59.89, K=41.10
  Passthrough (dims 16-63): Q=1298.74, K=67.72

  Q low/high ratio: 1.48x
  K low/high ratio: 0.76x
```

### 訓練済みモデル vs スクラッチ訓練の比較

| 指標 | 訓練済みPythia-70m | スクラッチ訓練（5K, 6epochs） | 倍率 |
|------|-------------------|------------------------------|------|
| PPL | **24.4** | 105.6 | 0.23x |
| Q max | **1298.74** | 8.79 | **148x** |
| Q mean | **40.49** | 0.85 | **48x** |
| Q std | **63.51** | 1.10 | **58x** |
| K max | **67.72** | 9.30 | **7.3x** |
| K mean | **18.58** | 0.81 | **23x** |
| K std | **22.93** | 1.04 | **22x** |

### 分析と考察

**1. Massive Valuesはパススルー領域に集中**

| 領域 | Q max | K max | 説明 |
|------|-------|-------|------|
| 高周波 (0-7) | 40.35 | 53.74 | RoPE適用、高速回転 |
| 低周波 (8-15) | 59.89 | 41.10 | RoPE適用、低速回転 |
| **パススルー (16-63)** | **1298.74** | **67.72** | **RoPE未適用、圧倒的に大きい** |

- **論文の主張（低周波に集中）とは異なり、RoPE未適用領域に集中**
- RoPE領域内では Q low/high = 1.48x（わずかに低周波優位）
- K は逆に高周波優位（0.76x）

**2. 後半レイヤーで急増**

- Layer 0-2: Q max = 11-16（スクラッチ訓練と同程度）
- Layer 3-5: Q max = **440-1299**（急激に増加）
- これは**深いレイヤーで知識が蓄積**されることを示唆

**3. 訓練量との関係**

- 訓練済み: Q max = 1298、mean = 40.5
- スクラッチ: Q max = 8.8、mean = 0.85
- **約150倍の差** → **Massive Valuesは十分な訓練で形成される**
- スクラッチ訓練（5K, 6epochs）では形成されない

**4. QとKの非対称性**

- Q: パススルー領域に最大値が集中（1298 vs 40-60）
- K: パススルー領域が最大だが差は小さい（67 vs 41-54）
- **Qの方がMassive Valuesの影響を強く受ける**

### 結論

| 観点 | 訓練済みPythia | スクラッチ訓練 |
|------|---------------|---------------|
| Massive Values | **明確に存在** | ほぼなし |
| 位置 | **パススルー領域** | 全体的に均等 |
| レイヤー依存性 | 後半で急増 | ほぼ均等 |
| 形成条件 | 十分な訓練が必要 | 5K/6epochsでは不足 |

**重要な発見**:
1. Massive Valuesは**十分に訓練されたモデルで形成**される
2. **パススルー領域（RoPE未適用）に集中**する（論文の低周波仮説とは異なる）
3. **後半レイヤー（Layer 3-5）で急激に増加**
4. **Qの方がKより顕著**（約20倍の差）

### 次元ペアごとの詳細分析

**theta = base^(-2i/rotary_dim)** で回転速度が決定される（base=10000）。

| dims | theta | Q max | K max | Region |
|------|-------|-------|-------|--------|
| 0-1 | 1.0000 | 20.17 | 39.70 | RoPE (high) |
| 2-3 | 0.3162 | 27.79 | 32.05 | RoPE (high) |
| 4-5 | 0.1000 | 34.97 | 33.19 | RoPE (high) |
| 6-7 | 0.0316 | 40.35 | 53.74 | RoPE (high) |
| 8-9 | 0.0100 | 18.94 | 40.70 | RoPE (low) |
| 10-11 | 0.0032 | 27.13 | 35.10 | RoPE (low) |
| 12-13 | 0.0010 | 33.98 | 37.03 | RoPE (low) |
| 14-15 | 0.0003 | 59.89 | 41.10 | RoPE (low) |
| **16-17** | (none) | **758.41** | 66.69 | **Passthrough** |
| **18-19** | (none) | **1261.08** | 67.46 | **Passthrough** |
| **20-21** | (none) | **1080.18** | 65.02 | **Passthrough** |
| **22-23** | (none) | **951.70** | 66.80 | **Passthrough** |
| **24-25** | (none) | **1103.76** | 66.71 | **Passthrough** |
| **26-27** | (none) | **827.95** | 67.72 | **Passthrough** |
| **28-29** | (none) | **1099.01** | 66.43 | **Passthrough** |
| **30-31** | (none) | **1045.17** | 66.61 | **Passthrough** |
| **32-33** | (none) | **1298.74** | 67.22 | **Passthrough** |
| **34-35** | (none) | **922.11** | 63.07 | **Passthrough** |
| **36-37** | (none) | **992.92** | 66.91 | **Passthrough** |
| **38-39** | (none) | **829.59** | 67.31 | **Passthrough** |
| **40-41** | (none) | **859.72** | 65.15 | **Passthrough** |
| **42-43** | (none) | **767.14** | 64.34 | **Passthrough** |
| **44-45** | (none) | **1102.13** | 64.46 | **Passthrough** |
| **46-47** | (none) | **940.68** | 64.34 | **Passthrough** |
| **48-49** | (none) | **913.44** | 66.38 | **Passthrough** |
| **50-51** | (none) | **1203.92** | 66.63 | **Passthrough** |
| **52-53** | (none) | **929.02** | 67.05 | **Passthrough** |
| **54-55** | (none) | **956.57** | 64.54 | **Passthrough** |
| **56-57** | (none) | **915.46** | 67.10 | **Passthrough** |
| **58-59** | (none) | **824.62** | 67.08 | **Passthrough** |
| **60-61** | (none) | **1239.50** | 66.54 | **Passthrough** |
| **62-63** | (none) | **910.69** | 64.45 | **Passthrough** |

### 分布パターンの可視化

```
Q max:
1300 |                    ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ (Passthrough全体で巨大)
1200 |                    █                      █
1100 |                    █   █     █ █     █
1000 |                    █ █ █ █ █ █ █   █   █ █
 900 |                      █ █ █ █ █ █ █ █ █ █ █ █
 800 |                    █     █         █   █
  60 |              *
  40 |        * *
  20 |  * * *
   0 +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--
      0  4  8  12 16 20 24 28 32 36 40 44 48 52 56 60
      ←―― RoPE ――→ ←―――――――― Passthrough ―――――――→
```

### 分布パターンの結論

**仮説A確定**: Massive ValuesはPassthrough領域**全体**に均等分布

| 領域 | Q max範囲 | K max範囲 | 特徴 |
|------|----------|----------|------|
| RoPE高周波 (0-7) | 20-40 | 32-54 | 小さい |
| RoPE低周波 (8-15) | 19-60 | 35-41 | 小さい |
| **Passthrough (16-63)** | **758-1299** | **63-68** | **全次元で巨大** |

**観察**:
1. **特定次元への集中なし**: Passthrough領域のすべての次元ペアで Q max > 750
2. **K は均等**: Passthrough領域でK max ≈ 65（ほぼ均一、Qほどの差はない）
3. **RoPE領域ではthetaに弱い相関**: theta↓ → Q↑（ただし最大でも60）
4. **Pythiaの設計意図**: rotary_pct=0.25は意図的。Passthrough領域がコンテキスト知識の保存に使用されている可能性

---

## Q, K統計分析 (Massive Values検証) - 2025-12-05

### 目的

論文 "Massive Values in Self-Attention Modules are the Key to Contextual Knowledge Understanding" の主張を検証:
- Q, Kベクトルの低周波領域にMassive Values（巨大値）が集中するか？

### 実験設定

- モデル: RoPE (2D), 5,000サンプル, 6 epochs訓練後
- 分析: 10バッチで Q, K の最大値を収集
- **次元配置**:
  - rotary_dim = 16 (head_dim × 0.25)
  - 高周波: dims 0-7（RoPE適用、周波数高）
  - 低周波: dims 8-15（RoPE適用、周波数低）
  - パススルー: dims 16-63（RoPE未適用）

### 結果（修正コードでの再実験）

**全体統計**:
```
Overall Q max: 11.36
Overall K max: 9.77
```

**レイヤー別最大値**:

| Layer | Q max | K max |
|-------|-------|-------|
| 0 | 10.01 | 8.18 |
| 1 | 10.45 | 8.33 |
| 2 | 9.42 | 9.77 |
| 3 | 10.62 | 9.45 |
| 4 | 11.13 | 9.29 |
| 5 | 11.36 | 8.86 |

**傾向**: Q, K両方とも後半レイヤーで最大値が大きくなる傾向

### 周波数帯域別分析（修正後）

```
Frequency band analysis (rotary_dim=16, head_dim=64):
  RoPE applied: dims 0-15
    High-freq (dims 0-7):  Q=11.01, K=9.45
    Low-freq (dims 8-15):  Q=11.36, K=9.77
  Passthrough (dims 16-63): Q=6.19, K=4.91

  Q low/high ratio: 1.03x
  K low/high ratio: 1.03x
```

### 分析と考察

**結果サマリー**:

| 領域 | Q max | K max | 説明 |
|------|-------|-------|------|
| 高周波 (0-7) | 11.01 | 9.45 | RoPE適用、高速回転 |
| 低周波 (8-15) | 11.36 | 9.77 | RoPE適用、低速回転 |
| パススルー (16-63) | 6.19 | 4.91 | RoPE未適用 |

**観察**:

1. **低周波/高周波比 ≈ 1.03**: 論文の主張（低周波にMassive Values集中）とは異なり、**高周波と低周波でほぼ同等**
2. **パススルー領域が最小**: RoPE未適用の48次元は最大値が約半分（Q: 6.19, K: 4.91）
3. **RoPE適用領域に大きな値が集中**: 位置情報を持つ次元に大きな値がある

### 論文との比較

| 項目 | 論文の主張 | 本実験結果 |
|------|-----------|-----------|
| Massive Valuesの位置 | 低周波領域に集中 | **高周波≒低周波（1.03倍）** |
| 比率 | 顕著な差 | **ほぼ同等** |
| パススルー | - | 最小値（約半分） |

**考えられる理由**:

1. **訓練データ量**: 5,000サンプルは論文のスケール（数十億トークン）と比較して非常に小さい
2. **訓練epoch数**: 6 epochsは収束には不十分で、Massive Valuesが形成途中の可能性
3. **モデルサイズ**: 70Mパラメータは論文のモデル（1B〜7B）と比較して小さい

### ⚠️ 初回分析時のバグと修正（履歴）

**バグ**: 初回実験では、周波数帯域の分類が誤っていた。

```
❌ 誤った分類: head_dim=64 の前半32次元 vs 後半32次元
✅ 正しい分類: rotary_dim=16 の前半8次元（高周波） vs 後半8次元（低周波）
```

**問題点**: RoPEはhead_dimの25%（16次元）のみに適用される。残り48次元はパススルー（位置情報なし）。周波数帯域分析はrotary_dim内で行う必要がある。

### 今後の検証

1. **より大きなモデル**: 1B〜7Bパラメータでの検証
2. **より多くの訓練**: 100K〜1Mサンプルでの変化を観察
3. **訓練途中の観察**: epoch毎にQ, K統計を取得し、Massive Valuesの形成過程を追跡

---

## rotary_pct=1.0 実験（全次元RoPE適用）- 2025-12-05

### 目的

前回の実験（rotary_pct=0.25）ではパススルー領域（RoPE未適用）が48次元あった。
全64次元にRoPEを適用し、純粋に高周波vs低周波の比較を行う。

### 実験設定

- モデル: RoPE (2D), 5,000サンプル, 6 epochs訓練後
- **rotary_pct = 1.0**（全次元にRoPE適用）
- **次元配置**:
  - rotary_dim = 64 (head_dim × 1.0)
  - 高周波: dims 0-31
  - 低周波: dims 32-63
  - パススルー: なし

### 結果

**全体統計**:
```
Overall Q max: 8.58
Overall K max: 9.61
```

**レイヤー別最大値**:

| Layer | Q max | K max |
|-------|-------|-------|
| 0 | 7.96 | 7.33 |
| 1 | 7.41 | 9.61 |
| 2 | 7.51 | 7.24 |
| 3 | 7.80 | 9.39 |
| 4 | 8.58 | 8.42 |
| 5 | 8.23 | 7.89 |

**周波数帯域別分析**:

```
Frequency band analysis (rotary_dim=64, head_dim=64):
  RoPE applied: dims 0-63
    High-freq (dims 0-31):  Q=8.46, K=9.61
    Low-freq (dims 32-63):  Q=8.58, K=9.33

  Q low/high ratio: 1.01x
  K low/high ratio: 0.97x
```

### rotary_pct 比較

| 設定 | rotary_pct=0.25 | rotary_pct=1.0 | 変化 |
|------|-----------------|----------------|------|
| rotary_dim | 16 | 64 | +48 |
| Overall Q max | 11.36 | 8.58 | -24% |
| Overall K max | 9.77 | 9.61 | -2% |
| Q low/high ratio | 1.03x | 1.01x | ≈同等 |
| K low/high ratio | 1.03x | 0.97x | ≈同等 |
| PPL | 105.3 | 105.6 | +0.3% |

### 分析と考察

**1. Q, Kの最大値が減少（特にQ）**
- Q max: 11.36 → 8.58（**24%減少**）
- K max: 9.77 → 9.61（2%減少）
- 全次元にRoPEを適用すると、値が全体的に分散される

**2. low/high ratioは依然として≈1.0**
- Q: 1.01x、K: 0.97x
- **論文の主張（低周波にMassive Values集中）は再現されず**
- 小規模訓練ではMassive Valuesが形成されない

**3. PPLはほぼ同等**
- rotary_pct=0.25: 105.3
- rotary_pct=1.0: 105.6
- 全次元にRoPEを適用しても性能はほぼ変わらない

**4. パススルー領域の役割**
- rotary_pct=0.25ではパススルー領域の値が小さかった（Q: 6.19, K: 4.91）
- これは**RoPEが適用されない次元は活性化が低い**ことを示す
- 全次元RoPEでは値が均等に分布

### 結論

| 観点 | rotary_pct=0.25 | rotary_pct=1.0 |
|------|-----------------|----------------|
| PPL | 105.3 | 105.6 |
| Q, K最大値 | 高い（11.36） | 低い（8.58） |
| low/high ratio | ≈1.0 | ≈1.0 |
| パススルー | あり（値小） | なし |

**Massive Values仮説の検証結果**: 小規模訓練（5,000サンプル、6 epochs）では、rotary_pctに関わらず低周波へのMassive Values集中は観察されなかった。

---

## rope_base=5000 実験（rotary_pct=0.25、パススルーあり）- 2025-12-05

### 目的

RoPEの回転速度を約2倍に高速化し、位置エンコーディングの性能への影響を調査。

### ⚠️ 注意: この実験の制限

この実験は`rotary_pct=0.25`（16次元のみRoPE適用）で実行されているため：
- パススルー領域（48次元）が存在
- 高周波/低周波の比較は16次元中の8次元 vs 8次元
- **純粋な回転速度比較には `rotary_pct=1.0` での実験が必要**（後述）

### RoPE base の仕組み

RoPEの周波数は以下の式で決定される：

```
inv_freq[i] = 1 / (base^(2i/d))
```

- `base = 10000`（デフォルト）: 標準速度
- `base = 5000`: 周波数が約1.4〜2倍に増加（回転が速い）

**具体的な周波数比較**:

| 次元ペア | base=10000 | base=5000 | 比率 |
|----------|------------|-----------|------|
| pair 0 | 1.0 | 1.0 | 1.0x |
| pair 1 | 0.316 | 0.447 | 1.4x |
| pair 2 | 0.100 | 0.200 | 2.0x |
| pair 3 | 0.032 | 0.089 | 2.8x |

### 実験設定

- モデル: RoPE (2D), 5,000サンプル, 6 epochs訓練後
- **rope_base = 5000**（回転速度約2倍）
- rotary_pct = 0.25（デフォルト）

### 結果

**全体統計**:
```
Overall Q max: 11.09
Overall K max: 10.76
```

**レイヤー別最大値**:

| Layer | Q max | K max |
|-------|-------|-------|
| 0 | 9.56 | 8.39 |
| 1 | 10.42 | 10.76 |
| 2 | 8.74 | 9.11 |
| 3 | 9.87 | 8.68 |
| 4 | 11.09 | 9.91 |
| 5 | 10.16 | 8.15 |

**周波数帯域別分析**:

```
Frequency band analysis (rotary_dim=16, head_dim=64):
  RoPE applied: dims 0-15
    High-freq (dims 0-7):  Q=11.02, K=10.38
    Low-freq (dims 8-15):  Q=11.09, K=10.76
  Passthrough (dims 16-63): Q=6.24, K=4.97

  Q low/high ratio: 1.01x
  K low/high ratio: 1.04x
```

### rope_base 比較（rotary_pct=0.25同士の比較）

**注意**: 両方とも`rotary_pct=0.25`で比較（パススルー領域あり）

| 設定 | base=10000 | base=5000 | 変化 |
|------|------------|-----------|------|
| rotary_pct | 0.25 | 0.25 | 同じ |
| rotary_dim | 16 | 16 | 同じ |
| 回転速度 | 標準 | 約2倍 | ↑ |
| PPL | 105.3 | 105.8 | +0.5% |
| Overall Q max | 11.36 | 11.09 | -2% |
| Overall K max | 9.77 | 10.76 | **+10%** |
| Q low/high ratio | 1.03x | 1.01x | ≈同等 |
| K low/high ratio | 1.03x | 1.04x | ≈同等 |
| Backward PPL | 760.1 | 773.1 | +1.7% |

### 分析と考察

**1. PPLはほぼ同等**
- base=10000: 105.3
- base=5000: 105.8
- 回転速度を2倍にしても性能はほぼ変わらない（+0.5%）

**2. K maxが増加**
- K max: 9.77 → 10.76（**+10%**）
- Q maxは微減: 11.36 → 11.09（-2%）
- 高速回転によりKの活性化が増加した可能性

**3. low/high ratioは依然として≈1.0**
- 回転速度を変えても、高周波と低周波の最大値比はほぼ同等
- Massive Valuesの形成は回転速度に依存しない

**4. Reversal Curseはわずかに悪化**
- Backward PPL: 760.1 → 773.1（+1.7%）
- 高速回転により方向依存性がわずかに強まった

### Position-wise PPL 比較

| Position | base=10000 | base=5000 | 変化 |
|----------|------------|-----------|------|
| 0-16 | 153.0 | 154.0 | +0.7% |
| 16-32 | 107.1 | 107.7 | +0.6% |
| 32-64 | 107.0 | 106.9 | -0.1% |
| 64-96 | 103.4 | 103.5 | +0.1% |
| 96-128 | 104.9 | 105.1 | +0.2% |

**観察**: 全position範囲でほぼ同等。回転速度の変更は距離別性能に影響しない。

### 結論

| 観点 | base=10000 | base=5000 |
|------|------------|-----------|
| PPL | 105.3 | 105.8 |
| K max | 9.77 | 10.76 (+10%) |
| Reversal Curse | 760.1 | 773.1 (+1.7%) |
| low/high ratio | ≈1.0 | ≈1.0 |

**回転速度変更の効果**:
- PPLへの影響は微小（+0.5%）
- K maxが10%増加するが、性能には影響しない
- Reversal Curseがわずかに悪化（+1.7%）
- **回転速度はRoPEの性能を大きく左右しない**

---

## rope_base=5000 実験（rotary_pct=1.0、パススルーなし、mean/std含む）- 2025-12-05

### 目的

全64次元にRoPEを適用した状態で回転速度を2倍にし、純粋な回転速度の影響を調査。
**今回の実験から mean と std も測定**。

### 実験設定

- モデル: RoPE (2D), 5,000サンプル, 6 epochs訓練後
- **rotary_pct = 1.0**（全次元にRoPE適用、パススルーなし）
- **rope_base = 5000 vs 10000**（回転速度比較）
- **次元配置**:
  - rotary_dim = 64 (head_dim × 1.0)
  - 高周波: dims 0-31
  - 低周波: dims 32-63
  - パススルー: なし

### 結果

#### base=10000（標準速度）

**全体統計**:
```
Overall Q: max=8.63, mean=0.84, std=1.09
Overall K: max=9.33, mean=0.80, std=1.04
```

**レイヤー別統計**:

| Layer | Q max | Q mean | Q std | K max | K mean | K std |
|-------|-------|--------|-------|-------|--------|-------|
| 0 | 6.99 | 0.65 | 0.89 | 6.90 | 0.64 | 0.86 |
| 1 | 7.06 | 0.85 | 1.10 | 8.75 | 0.78 | 1.00 |
| 2 | 7.37 | 0.85 | 1.09 | 6.96 | 0.80 | 1.03 |
| 3 | 7.68 | 0.83 | 1.07 | 9.33 | 0.81 | 1.05 |
| 4 | 8.47 | 0.90 | 1.15 | 8.36 | 0.86 | 1.11 |
| 5 | 8.63 | 0.98 | 1.26 | 7.80 | 0.92 | 1.18 |

**周波数帯域別分析**:

```
Frequency band analysis (rotary_dim=64, head_dim=64):
  RoPE applied: dims 0-63
    High-freq (dims 0-31):  Q=8.47, K=9.33
    Low-freq (dims 32-63):  Q=8.63, K=8.73

  Q low/high ratio: 1.02x
  K low/high ratio: 0.94x
```

#### base=5000（2倍速）

**全体統計**:
```
Overall Q: max=8.79, mean=0.85, std=1.10
Overall K: max=9.30, mean=0.81, std=1.04
```

**レイヤー別統計**:

| Layer | Q max | Q mean | Q std | K max | K mean | K std |
|-------|-------|--------|-------|-------|--------|-------|
| 0 | 6.18 | 0.65 | 0.89 | 6.72 | 0.64 | 0.86 |
| 1 | 6.47 | 0.85 | 1.10 | 9.30 | 0.78 | 1.01 |
| 2 | 8.05 | 0.86 | 1.10 | 8.10 | 0.81 | 1.04 |
| 3 | 8.63 | 0.85 | 1.09 | 8.87 | 0.82 | 1.06 |
| 4 | 8.79 | 0.92 | 1.17 | 8.02 | 0.87 | 1.11 |
| 5 | 7.82 | 0.98 | 1.25 | 6.99 | 0.93 | 1.18 |

**周波数帯域別分析**:

```
Frequency band analysis (rotary_dim=64, head_dim=64):
  RoPE applied: dims 0-63
    High-freq (dims 0-31):  Q=8.79, K=9.26
    Low-freq (dims 32-63):  Q=8.53, K=9.30

  Q low/high ratio: 0.97x
  K low/high ratio: 1.00x
```

### rope_base 比較（rotary_pct=1.0同士の純粋比較）

**注意**: 両方とも`rotary_pct=1.0`で比較（パススルーなし、純粋な回転速度比較）

| 設定 | base=10000 | base=5000 | 変化 |
|------|------------|-----------|------|
| rotary_pct | 1.0 | 1.0 | 同じ |
| rotary_dim | 64 | 64 | 同じ |
| パススルー | なし | なし | 同じ |
| 回転速度 | 標準 | 約2倍 | ↑ |
| PPL | 105.6 | 105.4 | **-0.2%** |
| Backward PPL | 660.5 | 681.7 | **+3.2%** |

### Q, K 統計の比較（max, mean, std）

| 指標 | base=10000 | base=5000 | 変化 |
|------|------------|-----------|------|
| Overall Q max | 8.63 | 8.79 | +2% |
| Overall Q mean | 0.84 | 0.85 | +1% |
| Overall Q std | 1.09 | 1.10 | +1% |
| Overall K max | 9.33 | 9.30 | 0% |
| Overall K mean | 0.80 | 0.81 | +1% |
| Overall K std | 1.04 | 1.04 | 0% |

**観察**: **mean と std はほぼ変化なし**。回転速度を変えても全体的な分布は同等。maxだけが微妙に変動。

### レイヤー別Q, K最大値の詳細比較

| Layer | Q max (10000) | Q max (5000) | 変化 | K max (10000) | K max (5000) | 変化 |
|-------|---------------|--------------|------|---------------|--------------|------|
| 0 | 6.99 | 6.18 | **-12%** | 6.90 | 6.72 | -3% |
| 1 | 7.06 | 6.47 | **-8%** | 8.75 | 9.30 | +6% |
| 2 | 7.37 | 8.05 | +9% | 6.96 | 8.10 | **+16%** |
| 3 | 7.68 | 8.63 | **+12%** | 9.33 | 8.87 | -5% |
| 4 | 8.47 | 8.79 | +4% | 8.36 | 8.02 | -4% |
| 5 | 8.63 | 7.82 | **-9%** | 7.80 | 6.99 | **-10%** |

**傾向**:
- **前半レイヤー（0-1）**: Q max が減少（-8%〜-12%）
- **中間レイヤー（2-3）**: Q max が増加（+9%〜+12%）、K は変動
- **最終レイヤー（5）**: Q, K 両方とも減少（-9%〜-10%）

### 周波数帯域別の詳細比較

| 領域 | Q max (10000) | Q max (5000) | 変化 | K max (10000) | K max (5000) | 変化 |
|------|---------------|--------------|------|---------------|--------------|------|
| 高周波 (0-31) | 8.47 | 8.79 | **+4%** | 9.33 | 9.26 | -1% |
| 低周波 (32-63) | 8.63 | 8.53 | -1% | 8.73 | 9.30 | **+7%** |
| low/high ratio (Q) | 1.02x | 0.97x | **-5%** | - | - | - |
| low/high ratio (K) | 0.94x | 1.00x | **+6%** | - | - | - |

**観察**:
- **Q**: 高周波が+4%増加、低周波は-1%減少 → 高周波が相対的に増加
- **K**: 低周波が+7%増加、高周波は-1%減少 → 低周波が相対的に増加
- **QとKで逆の傾向**が見られる

### Position-wise PPL 比較

| Position | base=10000 | base=5000 | 変化 |
|----------|------------|-----------|------|
| 0-16 | 144.2 | 143.7 | -0.3% |
| 16-32 | 105.4 | 105.6 | +0.2% |
| 32-64 | 105.1 | 104.6 | -0.5% |
| 64-96 | 101.9 | 101.7 | -0.2% |
| 96-128 | 102.4 | 102.5 | +0.1% |

**観察**: Position-wise PPLはほぼ変化なし。

### 分析と考察

**1. PPLはほぼ同等**
- base=10000: 105.6
- base=5000: 105.4（**-0.2%**）
- 回転速度を2倍にしてもPPLはほぼ変わらない

**2. mean, stdは変化なし**
- Q mean: 0.84 → 0.85（+1%）
- Q std: 1.09 → 1.10（+1%）
- K mean: 0.80 → 0.81（+1%）
- K std: 1.04 → 1.04（0%）
- **回転速度を変えても全体的な値の分布は同等**

**3. maxのみ微妙に変動**
- Q max: +2%
- K max: 0%
- **Massive Valuesの形成は回転速度に依存しない**

**4. QとKで周波数帯域の反応が逆**
- Q: 高周波が相対的に増加（low/high: 1.02x → 0.97x、-5%）
- K: 低周波が相対的に増加（low/high: 0.94x → 1.00x、+6%）
- 興味深い非対称性

**5. レイヤー別の傾向**
- 前半レイヤー: 値が減少
- 中間レイヤー: 値が増加
- 最終レイヤー: 値が減少
- 回転速度増加により「前半と最終を抑制、中間を活性化」する効果

**6. Reversal Curseがわずかに悪化**
- Backward PPL: 660.5 → 681.7（+3.2%）
- ※前回の実験（760.1 → 681.7）とは異なる結果。シード依存の可能性

### 結論

| 観点 | base=10000 | base=5000 | 変化 |
|------|------------|-----------|------|
| PPL | 105.6 | 105.4 | -0.2% |
| Q mean | 0.84 | 0.85 | +1% |
| Q std | 1.09 | 1.10 | +1% |
| K mean | 0.80 | 0.81 | +1% |
| K std | 1.04 | 1.04 | 0% |
| Q low/high ratio | 1.02x | 0.97x | -5% |
| K low/high ratio | 0.94x | 1.00x | +6% |

**rotary_pct=1.0での回転速度2倍の効果**:
- PPLへの影響は微小（-0.2%）
- **mean, stdはほぼ変化なし**（全体分布は同等）
- **maxのみ微妙に変動**
- **QとKで周波数帯域の反応が逆**（Q: 高周波↑、K: 低周波↑）
- **Massive Values仮説は再現されず**（low/high ratio ≈ 1.0）

---

## 5,000サンプル実験（参考）- 2025-12-05

### 結果サマリー

| Position Encoding | PPL | Best Epoch | RoPE比 |
|-------------------|-----|------------|--------|
| **RoPE (25%)** | **107.4** | 6 | baseline |
| ALiBi | 114.9 | 6 | +7.0% |
| NoPE (None) | 131.5 | 6 | +22.4% |

### Reversal Curse評価

| Model | Forward PPL | Backward PPL | Ratio | Gap |
|-------|-------------|--------------|-------|-----|
| RoPE (25%) | 1.7 | 760.1 | 0.002 | +758.5 |
| ALiBi | 1.7 | 683.5 | 0.002 | +681.9 |
| NoPE (None) | 1.7 | 644.7 | 0.003 | +643.0 |

---

## RoPE3D 回転軸の比較実験 - 2025-12-05

### 目的

RoPE3Dの3D回転軸を変更し、位置エンコーディングの性能への影響を調査。

### 軸の設定

| 軸名 | ベクトル | 正規化後 | 特徴 |
|------|---------|---------|------|
| 対称軸 | (1, 1, 1) | (0.577, 0.577, 0.577) | 各次元への影響が均等 |
| 非対称軸 | (1, 2, 3) | (0.267, 0.535, 0.802) | 各次元への影響が異なる |

### 結果

| 回転軸 | PPL | Epoch | Backward PPL | Reversal Gap |
|--------|-----|-------|--------------|--------------|
| RoPE (2D) baseline | 90.3 | 5 | 637.9 | +636.2 |
| RoPE3D (1,1,1) 対称 | 90.7 | 5 | 805.6 | +803.9 |
| RoPE3D (1,2,3) 非対称 | **90.8** | 5 | 755.6 | +753.9 |

### Position-wise PPL 比較

| Position | RoPE (2D) | RoPE3D (1,1,1) | RoPE3D (1,2,3) |
|----------|-----------|----------------|----------------|
| 0-16 | 148.2 | 147.7 | 147.7 |
| 16-32 | 89.0 | 88.7 | **89.8** |
| 32-64 | 85.2 | **85.7** | **85.5** |
| 64-96 | 86.8 | **86.7** | **87.1** |
| 96-128 | **81.7** | **82.1** | **82.1** |

### 分析

**PPLの差異**:
- 対称軸(1,1,1): 90.7 (RoPE比 +0.4%)
- 非対称軸(1,2,3): 90.8 (RoPE比 +0.6%)
- 非対称軸は対称軸よりわずかに劣化 (+0.1%)

**Reversal Curseの改善**:
- 非対称軸(1,2,3)のBackward PPL: 755.6
- 対称軸(1,1,1)のBackward PPL: 805.6
- **非対称軸は逆方向の予測精度が約6%改善**

**考察**:
1. **PPLはほぼ同等**: 回転軸の変更による順方向PPLの差は微差（0.1%）
2. **Reversal Curseが改善**: 非対称軸は対称軸より50ポイント（約6%）改善
3. **各次元への不均等な影響**: 非対称軸(1,2,3)では各次元が異なる比率で変化するため、方向依存性がやや緩和された可能性

**結論**: 回転軸の変更は順方向PPLにほとんど影響しないが、Reversal Curseには一定の影響を与える。非対称軸は対称軸よりReversal Curseを約6%緩和した。ただし、2D RoPEのReversal Gap (+636.2)と比較すると依然として大きい (+753.9)。

---

## 実行コマンド

```bash
# RoPE baseline (10,000 samples)
python3 scripts/experiment_position.py --samples 10000 --epochs 30 --pos-types rope

# RoPE3D (10,000 samples)
python3 scripts/experiment_position.py --samples 10000 --epochs 30 --pos-types rope3d

# RoPE vs RoPE3D 比較
python3 scripts/experiment_position.py --samples 10000 --epochs 30 --pos-types rope rope3d

# 全種類比較
python3 scripts/experiment_position.py --samples 10000 --epochs 30 --pos-types rope rope3d alibi none
```

---

Last Updated: 2025-12-05 (次元ペアごとの詳細分析追加、仮説A確定)
