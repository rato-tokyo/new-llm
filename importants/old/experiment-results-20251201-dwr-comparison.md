# dist_reg_weight 比較実験 (2025-12-01)

## 実験概要

2つの実験を比較し、`dist_reg_weight`設定が多様性アルゴリズムの性能に与える影響を分析。

| 項目 | 1201_dwr_100 | 1201_dwr_090 |
|------|-------------|-------------|
| dist_reg_weight | 1.0 (CVFP無効) | 0.9 (CVFP 10%) |
| 実行時間 | 32.1 min | 44.2 min |
| 設定 | 多様性100% | 多様性90%, CVFP 10% |

**共通設定:**
- context_dim: 1000
- num_layers: 1
- phase1_max_iterations: 60
- phase2_epochs: 20
- サンプル数: [50, 100, 200]
- GPU: NVIDIA L4 (22.2GB)

---

## Phase 1 結果比較

### Effective Rank (Val ER) 比較

| Algorithm | Samples | dwr=1.0 Val ER | dwr=0.9 Val ER | 差分 |
|-----------|---------|----------------|----------------|------|
| **MCDL** | 50 | 61.4% | **67.3%** | +5.9% |
| **MCDL** | 100 | 61.2% | **67.1%** | +5.9% |
| **MCDL** | 200 | 62.3% | **67.9%** | +5.6% |
| **ODCM** | 50 | 73.7% | **73.8%** | +0.1% |
| **ODCM** | 100 | **75.8%** | 71.7% | -4.1% |
| **ODCM** | 200 | 70.6% | **75.6%** | +5.0% |
| **SDL** | 50 | 73.7% | **95.1%** | +21.4% |
| **SDL** | 100 | 73.8% | **95.2%** | +21.4% |
| **SDL** | 200 | 73.9% | **95.1%** | +21.2% |
| **NUC** | 50 | **92.3%** | 92.6% | +0.3% |
| **NUC** | 100 | **92.3%** | 92.8% | +0.5% |
| **NUC** | 200 | **92.5%** | 92.9% | +0.4% |

### Phase 1 イテレーション数比較

| Algorithm | dwr=1.0 | dwr=0.9 | 差分 |
|-----------|---------|---------|------|
| **MCDL** | 10 iter | 10 iter | 0 |
| **ODCM** | 20 iter | 20 iter | 0 |
| **SDL** | **10 iter** | **50 iter** | +40 |
| **NUC** | 60 iter | 60 iter | 0 |

**重要発見:** SDLは`dwr=1.0`で早期停止（10 iter）、`dwr=0.9`では50 iterまで継続。

---

## Phase 2 結果比較

### Val PPL 比較

| Algorithm | Samples | dwr=1.0 PPL | dwr=0.9 PPL | 改善率 |
|-----------|---------|-------------|-------------|--------|
| **MCDL** | 50 | 530.0 | **532.6** | -0.5% |
| **MCDL** | 100 | 407.3 | **409.9** | -0.6% |
| **MCDL** | 200 | **365.5** | 371.0 | -1.5% |
| **ODCM** | 50 | **664.4** | 821.4 | -23.6% |
| **ODCM** | 100 | **461.2** | 533.1 | -15.6% |
| **ODCM** | 200 | **408.0** | 430.6 | -5.5% |
| **SDL** | 50 | **634.2** | 675.5 | -6.5% |
| **SDL** | 100 | **498.1** | 511.5 | -2.7% |
| **SDL** | 200 | **442.1** | 440.6 | +0.3% |
| **NUC** | 50 | **714.3** | 720.1 | -0.8% |
| **NUC** | 100 | **537.1** | 536.6 | +0.1% |
| **NUC** | 200 | **462.3** | 457.8 | +1.0% |

### Val Accuracy 比較

| Algorithm | Samples | dwr=1.0 Acc | dwr=0.9 Acc | 差分 |
|-----------|---------|-------------|-------------|------|
| **MCDL** | 50 | 16.9% | 16.9% | 0% |
| **MCDL** | 100 | 18.4% | **18.5%** | +0.1% |
| **MCDL** | 200 | 18.7% | **18.9%** | +0.2% |
| **ODCM** | 50 | **16.1%** | 14.3% | -1.8% |
| **ODCM** | 100 | **17.7%** | 16.5% | -1.2% |
| **ODCM** | 200 | **18.0%** | 17.8% | -0.2% |
| **SDL** | 50 | **15.7%** | 15.6% | -0.1% |
| **SDL** | 100 | **17.2%** | 16.6% | -0.6% |
| **SDL** | 200 | 17.3% | **17.4%** | +0.1% |
| **NUC** | 50 | 15.1% | 15.1% | 0% |
| **NUC** | 100 | 16.2% | **16.3%** | +0.1% |
| **NUC** | 200 | 16.9% | **17.2%** | +0.3% |

---

## Scaling Law (α値) 比較

| Algorithm | dwr=1.0 α | dwr=0.9 α | 差分 | dwr=1.0 R² | dwr=0.9 R² |
|-----------|-----------|-----------|------|-----------|-----------|
| **MCDL** | -0.277 | **-0.270** | +0.007 | 0.945 | 0.937 |
| **ODCM** | -0.364 | **-0.482** | -0.118 | 0.924 | **0.963** |
| **SDL** | -0.269 | **-0.319** | -0.050 | 0.963 | **0.970** |
| **NUC** | -0.325 | **-0.338** | -0.013 | 0.969 | **0.971** |

**α値ランキング (dwr=0.9):**
1. **ODCM: α=-0.482** ← 最良のスケーリング
2. NUC: α=-0.338
3. SDL: α=-0.319
4. MCDL: α=-0.270

---

## 主要な発見

### 1. SDL の劇的な改善

**dwr=1.0 (CVFP無効):**
- 10 iterで早期停止
- Val ER: 73-74%
- 訓練が不安定

**dwr=0.9 (CVFP 10%):**
- 50 iterまで継続
- Val ER: **95%以上**
- 安定した訓練

**結論:** SDLはCVFP 10%の安定化効果が極めて重要。

### 2. MCDL の安定性

- 両設定で最も安定
- Val ERは dwr=0.9 で約6%向上
- PPLは両設定でほぼ同等（最良）
- α値は最も浅い（-0.27）

### 3. ODCM のスケーリング優位性

- dwr=0.9 で α=-0.482 を達成（最良）
- R²も0.963と高い信頼性
- ただしPPLはMCDLに劣る

### 4. NUC の一貫性

- 両設定で60 iter完走
- Val ER: 92%以上で安定
- PPLは中間的な性能

---

## 結論

### 推奨設定

```python
dist_reg_weight = 0.9  # 多様性90%, CVFP 10%
```

### アルゴリズム選択指針

| 目的 | 推奨アルゴリズム | 理由 |
|------|-----------------|------|
| **最良PPL** | MCDL | PPL=371.0, Acc=18.9% |
| **最良スケーリング** | ODCM | α=-0.482 (最も急峻) |
| **最高ER** | SDL | Val ER=95%以上 |
| **安定性** | NUC | 60 iter完走、92%+ ER |

### dist_reg_weight の影響

1. **dwr=1.0 (CVFP無効):**
   - 訓練が不安定になりやすい
   - 特にSDLで早期停止が発生
   - 一部でPPLが良いケースもある

2. **dwr=0.9 (CVFP 10%):**
   - 訓練が安定
   - SDLで劇的な改善（ER +21%）
   - スケーリング（α値）が改善

**最終推奨:** `dist_reg_weight=0.9` を標準設定として採用。

---

## 詳細データ

### dwr=1.0 全結果

```
Algo   Samples     Tokens P1 Iter  Train ER  Val ER BestValER   T.PPL   V.PPL    Acc   Time
MCDL        50     62,891      10     63.7%   61.4%     62.5%   221.3   530.0  16.9%    30s
MCDL       100    122,795      10     63.9%   61.2%     62.3%   193.9   407.3  18.4%    51s
MCDL       200    240,132      10     64.8%   62.3%     62.7%   236.3   365.5  18.7%    83s
ODCM        50     62,891      20     81.9%   73.7%     76.3%   186.8   664.4  16.1%    48s
ODCM       100    122,795      20     81.9%   75.8%     75.6%   158.4   461.2  17.7%    81s
ODCM       200    240,132      20     82.0%   70.6%     75.8%   205.1   408.0  18.0%   132s
SDL         50     62,891      10     80.6%   73.7%     74.1%   250.2   634.2  15.7%    41s
SDL        100    122,795      10     80.7%   73.8%     74.0%   188.9   498.1  17.2%    73s
SDL        200    240,132      10     80.8%   73.9%     73.9%   233.9   442.1  17.3%   124s
NUC         50     62,891      60     93.9%   92.3%     91.8%   313.7   714.3  15.1%   183s
NUC        100    122,795      60     93.8%   92.3%     91.9%   278.8   537.1  16.2%   324s
NUC        200    240,132      60     93.9%   92.5%     92.1%   226.7   462.3  16.9%   575s
```

### dwr=0.9 全結果

```
Algo   Samples     Tokens P1 Iter  Train ER  Val ER BestValER   T.PPL   V.PPL    Acc   Time
MCDL        50     62,891      10     69.7%   67.3%     69.6%   203.5   532.6  16.9%    31s
MCDL       100    122,795      10     69.9%   67.1%     69.6%   183.4   409.9  18.5%    50s
MCDL       200    240,132      10     70.6%   67.9%     69.5%   225.0   371.0  18.9%    84s
ODCM        50     62,891      20     83.9%   73.8%     80.3%   291.2   821.4  14.3%    46s
ODCM       100    122,795      20     84.4%   71.7%     80.1%   237.4   533.1  16.5%    77s
ODCM       200    240,132      20     84.0%   75.6%     80.3%   184.8   430.6  17.8%   137s
SDL         50     62,891      50     96.1%   95.1%     95.1%   287.2   675.5  15.6%   158s
SDL        100    122,795      50     96.2%   95.2%     95.1%   247.8   511.5  16.6%   275s
SDL        200    240,132      50     96.1%   95.1%     95.0%   202.5   440.6  17.4%   503s
NUC         50     62,891      60     93.8%   92.6%     92.3%   319.2   720.1  15.1%   181s
NUC        100    122,795      60     93.8%   92.8%     92.4%   274.6   536.6  16.3%   324s
NUC        200    240,132      60     94.0%   92.9%     92.5%   226.4   457.8  17.2%   587s
```

---

*実験日: 2025-12-01*
*環境: Google Colab, NVIDIA L4 GPU*
