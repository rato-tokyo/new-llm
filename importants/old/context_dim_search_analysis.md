# Context Dim 探索実験の分析

## 実験概要

サンプル数に対する最適な `context_dim` を探索する実験を実施。

| 実験 | サンプル数 | dim刻み | 探索範囲 |
|------|-----------|---------|----------|
| 実験1 | 100 | 50 | 50-500 |
| 実験2 | 200 | 100 | 100-500 |

## 結果サマリー

| 実験 | サンプル数 | 最適 dim | Best PPL | Best Acc | 最適時ER% |
|------|-----------|----------|----------|----------|-----------|
| 実験1 | 100 | **300** | 327.3 | 19.0% | 65.9% |
| 実験2 | 200 | **300** | 253.5 | 19.7% | 66.2% |

## 詳細データ

### 実験1: 100サンプル（dim刻み50）

| dim | PPL | Acc | ER% | 備考 |
|-----|-----|-----|-----|------|
| 50 | 383.9 | 17.2% | 81.7% | |
| 100 | 352.3 | 18.0% | 76.9% | |
| 150 | 345.6 | 18.5% | 74.4% | |
| 200 | 338.0 | 18.7% | 70.8% | |
| 250 | 338.3 | 18.8% | 68.1% | |
| **300** | **327.3** | **19.0%** | 65.9% | **★ Best** |
| 350 | 327.5 | 19.0% | 64.0% | |
| 400 | 330.4 | 19.2% | 61.9% | 停止 |

### 実験2: 200サンプル（dim刻み100）

| dim | PPL | Acc | ER% | 備考 |
|-----|-----|-----|-----|------|
| 100 | 272.3 | 19.2% | 76.5% | |
| 200 | 257.0 | 19.7% | 70.9% | |
| **300** | **253.5** | **19.7%** | 66.2% | **★ Best** |
| 400 | 258.0 | 19.8% | 61.3% | |
| 500 | 258.3 | 19.9% | 54.7% | 収束71%、停止 |

## 発見した傾向

### 1. 最適 context_dim はサンプル数に依存しない可能性

両実験で**最適 dim = 300**という同一の結果が得られた。サンプル数が2倍（100→200）になっても、最適 context_dim は変わらなかった。

**仮説**: context_dim の最適値は、サンプル数よりも**モデルアーキテクチャ**（embed_dim=768など）に依存している可能性がある。

### 2. サンプル数増加で PPL が大幅改善

| dim | 100 samples | 200 samples | 改善率 |
|-----|-------------|-------------|--------|
| 100 | 352.3 | 272.3 | **-22.7%** |
| 200 | 338.0 | 257.0 | **-24.0%** |
| 300 | 327.3 | 253.5 | **-22.5%** |
| 400 | 330.4 | 258.0 | **-21.9%** |

サンプル数2倍で、PPLは約**22-24%改善**。データ量増加の効果は一貫している。

### 3. Effective Rank と PPL のトレードオフ

```
dim↑ → ER%↓ → ある点で PPL 改善が頭打ち
```

- dim が増えると **ER% が低下**する
  - dim=100: ~76%
  - dim=300: ~66%
  - dim=500: ~55%
- dim=300付近で **PPL が最適化**される
- それ以上増やすと、ER%低下のデメリットがPPL改善を上回る

### 4. 大きな context_dim での収束問題

200サンプルの dim=500 では:
- Phase 1 収束率: **71%**（他は90%+）
- `no improvement for 2 iterations` で早期停止

大きな context_dim は収束が不安定になりやすい。

### 5. PPL と Acc の相関

PPL改善に伴い Acc も改善するが、dim増加による Acc 改善は緩やか:
- dim=100→300: Acc +0.5%程度
- サンプル数100→200: Acc +0.7%程度

## 結論

1. **最適 context_dim ≈ 300** が安定的なスイートスポット
2. **ER% 65%前後**が PPL 最適化の目安
3. サンプル数増加は PPL 改善に効果的（2倍で約23%改善）
4. dim=400以上は収束不安定＆PPL悪化のリスク

## 今後の検証案

1. より大きなサンプル数（500, 1000, 2000）で dim=300 が最適か確認
2. dim=250〜350 の細かい刻み（25刻み）で詳細探索
3. embed_dim を変えた場合の最適 context_dim の変化

---

*実験日: 2024-12-02*
*環境: NVIDIA L4, 22.2GB VRAM*
