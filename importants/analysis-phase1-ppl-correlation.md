# Phase 1 指標から Phase 2 PPL を予測する分析 (2025-11-30)

## 概要

Phase 1（CVFP固定点学習）の指標から、Phase 2（トークン予測）の最終PPLを予測できるかを分析。

## 収集データ

21件の実験データを分析（v1, v2, v3, matrix実験）

### データ一覧

| Config | Samples | P1 Iter | Train ER | Val ER | Train PPL | Val PPL | Val Acc |
|--------|---------|---------|----------|--------|-----------|---------|---------|
| 1L_768d_1tok (v1) | 50 | 40 | 77.9% | 77.6% | 170.6 | 683.9 | 17.3% |
| 1L_768d_1tok (v1) | 100 | 40 | 78.3% | 77.5% | 150.8 | 415.8 | 19.1% |
| 1L_768d_1tok (v1) | 200 | 40 | 78.4% | 77.5% | 129.0 | 294.5 | 20.1% |
| 1L_768d_1tok (v1) | 500 | 40 | 78.6% | 77.5% | 108.3 | 198.2 | 22.6% |
| 1L_768d_1tok (v2) | 50 | 23 | 79.7% | 79.3% | 65.9 | 576.0 | 18.3% |
| 1L_768d_1tok (v2) | 100 | 23 | 79.9% | 79.2% | 91.3 | 386.5 | 19.7% |
| 1L_768d_1tok (v2) | 200 | 25 | 80.0% | 79.1% | 94.0 | 286.4 | 20.4% |
| 1L_768d_1tok (v2) | 500 | 23 | 80.3% | 79.2% | 93.4 | 196.3 | 22.8% |
| 1L_768d_2tok (v3) | 50 | 23 | 81.9% | 81.5% | 75.0 | 591.7 | 18.3% |
| 1L_768d_2tok (v3) | 100 | 23 | 82.1% | 81.3% | 92.0 | 400.3 | 19.8% |
| 1L_768d_2tok (v3) | 200 | 28 | 82.3% | 81.3% | 85.1 | 296.8 | 20.6% |
| 1L_768d_2tok (v3) | 400 | 23 | 82.4% | 81.4% | 80.4 | 211.0 | 22.6% |
| 1L_768d_2tok (v3) | 800 | 23 | 82.5% | 81.3% | 78.9 | 168.0 | 24.2% |
| 1L_1200d_1tok (v1) | 500 | 40 | 73.9% | 72.4% | 100.6 | 199.5 | 23.1% |
| 1L_1200d_1tok (v2) | 500 | 29 | 76.9% | 75.6% | 90.1 | 201.1 | 23.0% |
| 1L_1537d_1tok (v1) | 500 | 40 | 70.5% | 68.6% | 98.3 | 198.3 | 23.0% |
| 1L_1537d_1tok (v2) | 500 | 32 | 74.1% | 72.6% | 93.5 | 202.3 | 22.9% |

## 観察された傾向

### 1. Val ER と Val PPL の関係（最重要）

**同一サンプル数での比較（500サンプル以上）**:

| Config | Val ER | Val PPL | 相関 |
|--------|--------|---------|------|
| 768d (v1) | 77.5% | 198.2 | 基準 |
| 768d (v2) | 79.2% | 196.3 | ER↑ → PPL↓ |
| 768d 2tok (v3, 800samples) | 81.3% | 168.0 | ER↑↑ → PPL↓↓ |
| 1200d (v2) | 75.6% | 201.1 | ER↓ → PPL↑ |
| 1537d (v2) | 72.6% | 202.3 | ER↓↓ → PPL↑ |

**結論**: **Val ER が高いほど Val PPL が低い（良い）**

### 2. P1 収束イテレーション数と性能

| P1 Iter | 設定例 | Val PPL | 傾向 |
|---------|--------|---------|------|
| 23-25 | 768d v2/v3 | 168-196 | 最良 |
| 29-32 | 1200d/1537d v2 | 201-202 | やや悪い |
| 40 | v1全般（打ち切り） | 198-199 | 中程度 |

**結論**: **早く収束するほど良い結果になる傾向**
- ただし v1 は max_iterations=40 で打ち切りのため単純比較は困難

### 3. context_dim と Val ER の関係

| context_dim | Val ER (v2) | 変化 |
|-------------|-------------|------|
| 768 | 79.2% | 最高 |
| 1200 | 75.6% | -3.6% |
| 1537 | 72.6% | -6.6% |

**結論**: **context_dim が大きいほど Val ER が低下**
- 次元を有効活用できていない
- 768d が最も効率的

### 4. num_input_tokens と Val ER の関係

| input_tokens | Val ER | Val PPL |
|--------------|--------|---------|
| 1 | 79.2% | 196.3 |
| 2 | 81.3% | 168.0 |

**結論**: **2トークン入力で ER と PPL が両方改善**

## 予測可能性の評価

### 強い相関が見られる指標

1. **Val ER → Val PPL**: 負の相関（ER高い→PPL低い）
   - 同一設定内で特に強い相関
   - 異なる設定間でも傾向は維持
   - **最も信頼できる予測指標**

2. **Train ER → Val ER**: 強い正の相関
   - 差は常に1-2%程度
   - Train ER で Val ER を予測可能

### 弱い/複雑な相関

1. **P1 Iter → Val PPL**: 単純な相関なし
   - 早期収束は良い傾向だが、打ち切りの影響で解釈困難

2. **Train PPL → Val PPL**: サンプル数に依存
   - 同一設定・サンプル数では相関あり
   - 異なるサンプル数では汎化ギャップが変動

## 予測式の候補

### 単純モデル: Val ER ベース

観察データから近似:
```
Val PPL ≈ 500 - 4 × Val_ER (%)

例: Val ER = 81% → PPL ≈ 500 - 324 = 176 (実測: 168)
例: Val ER = 79% → PPL ≈ 500 - 316 = 184 (実測: 196)
```

誤差は約10-15%程度

### より精密なモデル（スケーリング則込み）

```
log(Val PPL) = α × log(tokens) + β × Val_ER + γ

推定係数:
- α ≈ -0.46 ~ -0.55（スケーリング指数）
- β ≈ -0.02（ER 1%あたりの効果）
- γ ≈ 定数項（設定依存）
```

## 結論

### Phase 1 から予測可能なこと

| 予測対象 | 予測指標 | 信頼度 |
|----------|----------|--------|
| Val ER | Train ER | 高（差は1-2%） |
| Val PPL相対順位 | Val ER | 高（ER高い→PPL低い） |
| 収束品質 | P1 Iter | 中（早い=良い傾向） |

### 予測困難なこと

1. 異なるサンプル数間のPPL絶対値比較（スケーリング則が必要）
2. 異なる設定間の絶対値比較（context_dim, layers等）

### 実用的な判断基準

**Phase 1 完了時点での品質判定**:

| Val ER | 判定 | 期待される結果 |
|--------|------|---------------|
| > 80% | 🟢 良好 | 良好な結果が期待できる |
| 75-80% | 🟡 中程度 | 標準的な結果 |
| < 75% | 🔴 要検討 | 設定見直しを推奨 |

**収束速度の目安**:

| P1 Iter | 判定 | 解釈 |
|---------|------|------|
| 23-25 | 🟢 最適 | 効率的な収束 |
| 26-30 | 🟡 普通 | 許容範囲 |
| 30+ | 🔴 遅い | 設定改善の余地あり |

## 活用例

### Phase 1 完了時のチェックリスト

1. **Val ER を確認**
   - 80%以上なら Phase 2 に進む
   - 75%未満なら設定見直し

2. **収束イテレーション数を確認**
   - 25以下なら良好
   - 30以上なら `dist_reg_weight` や `phase1_max_iterations` を調整

3. **Train ER と Val ER の差を確認**
   - 2%以内なら汎化良好
   - 5%以上なら過学習の兆候

### 早期打ち切りの判断

Phase 1 の途中で以下の兆候があれば打ち切り検討:
- Iter 20 で Val ER < 70%
- 収束率が Iter 15 以降も上昇しない
- CVFP loss が減少しない

## ログファイル参照

- v1実験: `importants/logs/1130_context_dim/`
- v2実験: `importants/logs/1130_v2/`
- v3実験: `importants/logs/1130_v3/`
- Matrix実験: `importants/logs/summary.json`
