# context_dim 500 vs 1000 比較実験 (2025-12-02)

## 概要

context_dim=500 と context_dim=1000 でのレイヤー構成（C1T1, C2T2）比較実験。

**共通環境**:
- GPU: NVIDIA L4 (22.2GB)
- Samples: 2000
- Train tokens: 2,403,563
- Val tokens: 22,723
- num_input_tokens: 1

---

## 結果サマリー

| Config | context_dim | Params | P1 Iter | Conv% | ER% | Val PPL | Val Acc | Total Time |
|--------|-------------|--------|---------|-------|-----|---------|---------|------------|
| **C1T1** | **500** | 40.2M | 30 | 92% | **79.7%** | **127.2** | **24.7%** | ~1200s |
| C1T1 | 1000 | 41.7M | 46 | 82% | 69.3% | 134.0 | 23.6% | 1490s |
| **C2T2** | **500** | 41.8M | 14 | 93% | **79.6%** | **132.2** | **24.4%** | 730s |
| C2T2 | 1000 | 44.9M | 24 | 91% | 73.4% | 137.9 | 24.4% | 992s |

---

## 詳細比較

### 1. PPL（低いほど良い）

| Config | cd=500 | cd=1000 | 差分 | 勝者 |
|--------|--------|---------|------|------|
| C1T1 | **127.2** | 134.0 | +5.3% | **cd=500** |
| C2T2 | **132.2** | 137.9 | +4.3% | **cd=500** |

**結論**: context_dim=500 が両構成で PPL 良好

### 2. Accuracy（高いほど良い）

| Config | cd=500 | cd=1000 | 差分 | 勝者 |
|--------|--------|---------|------|------|
| C1T1 | **24.7%** | 23.6% | -1.1% | **cd=500** |
| C2T2 | 24.4% | 24.4% | 0% | 同等 |

**結論**: C1T1 では cd=500 が優位、C2T2 では同等

### 3. Effective Rank（高いほど多様性が高い）

| Config | cd=500 | cd=1000 | 差分 | 勝者 |
|--------|--------|---------|------|------|
| C1T1 | **79.7%** | 69.3% | -10.4% | **cd=500** |
| C2T2 | **79.6%** | 73.4% | -6.2% | **cd=500** |

**結論**: cd=500 が圧倒的に高ER（次元を有効活用）

### 4. Phase 1 収束速度

| Config | cd=500 | cd=1000 | 差分 | 勝者 |
|--------|--------|---------|------|------|
| C1T1 | 30 iter | 46 iter | +53% 遅い | **cd=500** |
| C2T2 | 14 iter | 24 iter | +71% 遅い | **cd=500** |

**結論**: cd=500 の方が収束が速い

### 5. 処理時間

| Config | cd=500 | cd=1000 | 差分 |
|--------|--------|---------|------|
| C1T1 | ~1200s | 1490s | +24% |
| C2T2 | 730s | 992s | +36% |

**結論**: cd=1000 は処理時間が長い

---

## 指標別まとめ

| 指標 | cd=500 vs cd=1000 | 勝者 |
|------|-------------------|------|
| Val PPL | cd=500 が 4-5% 良い | **cd=500** |
| Val Acc | cd=500 が同等〜1%良い | **cd=500** |
| Effective Rank | cd=500 が 6-10% 高い | **cd=500** |
| 収束速度 | cd=500 が 50-70% 速い | **cd=500** |
| 処理時間 | cd=500 が 24-36% 短い | **cd=500** |

---

## Phase 1 詳細ログ

### C1T1 + cd=1000

```
Phase 1: 824.1s, 46 iter, conv=82%, ER=72.1%/69.3%
- 収束まで46イテレーション（cd=500では30）
- Early stop: improvement 0.6% < 1%
- 最終収束率: 82%（cd=500では92%）
```

### C2T2 + cd=1000

```
Phase 1: 534.7s, 24 iter, conv=91%, ER=75.3%/73.4%
- 収束まで24イテレーション（cd=500では14）
- Early stop: conv 91% >= 90%
- 最終収束率: 91%（cd=500では93%）
```

---

## Phase 2 詳細ログ

### C1T1 + cd=1000

```
Best: epoch 12, ppl=134.0, acc=23.6%
- Early stop at epoch 12 (PPL improvement 0.35 < 0.4)
- 学習パラメータ: 1,361,664
```

### C2T2 + cd=1000

```
Best: epoch 7, ppl=137.9, acc=24.4%
- Early stop at epoch 8
- 学習パラメータ: 2,721,792
```

---

## 重要な発見

### 1. context_dim=500 が全指標で優位

- **PPL**: 4-5% 改善
- **ER**: 6-10% 向上（次元活用効率が高い）
- **収束速度**: 50-70% 高速化
- **処理時間**: 24-36% 短縮

### 2. cd=1000 での ER 低下が顕著

| context_dim | ER (C1T1) | ER (C2T2) |
|-------------|-----------|-----------|
| 500 | 79.7% | 79.6% |
| 1000 | 69.3% | 73.4% |

**→ 高次元を活用しきれていない**

### 3. C2T2 は収束速度で優位

| context_dim | C1T1 iter | C2T2 iter | 速度比 |
|-------------|-----------|-----------|--------|
| 500 | 30 | 14 | 2.1x |
| 1000 | 46 | 24 | 1.9x |

**→ 2層構成は収束が速いが、最終性能は1層が良い**

---

## 結論

### 推奨構成

| 優先度 | 構成 | context_dim | 理由 |
|--------|------|-------------|------|
| **1位** | **C1T1** | **500** | 最良PPL (127.2)、最高Acc (24.7%)、高ER (79.7%) |
| 2位 | C2T2 | 500 | 収束速度優先時（14 iter）、PPL 132.2 |
| 非推奨 | C1T1/C2T2 | 1000 | 全指標で劣る |

### context_dim 増加のデメリット

| 項目 | cd=500 → 1000 |
|------|---------------|
| PPL | +4-5% 悪化 |
| ER | -6〜10% 低下 |
| 収束速度 | +50-70% 遅延 |
| 処理時間 | +24-36% 増加 |
| パラメータ | +1.5-3M 増加 |

**→ context_dim を 500 → 1000 に増やすメリットはない**

---

## 設定推奨

```python
# config.py
context_dim = 500    # 1000より良い結果
num_layers = 1       # C1T1構成
num_input_tokens = 1 # 現在の設定
```

---

*Last Updated: 2025-12-02*
