# 2-Block + prev_context_steps=2 実験結果

**Date**: 2025-12-03
**構成**: 2 ContextBlocks (カスケード連結) + 2つ前までのcontext
**context_dim per block**: 256
**combined_dim**: 1536 (256 × 2 blocks × 3 steps)
**Device**: NVIDIA L4 (22.2GB)

## 実験結果

| Samples | Tokens | Val PPL | Val Acc | ER% | Time |
|---------|--------|---------|---------|-----|------|
| 200 | 240,132 | 256.0 | 21.0% | 70.7% | 260.4s |
| 400 | 473,429 | 178.7 | 22.9% | 70.8% | 467.3s |
| 800 | 948,524 | 142.4 | 24.6% | 70.4% | 899.0s |
| **1600** | **1,920,992** | **114.7** | **25.7%** | **70.9%** | **1755.5s** |

## スケーリングモデル比較

### AICによるモデル選択

| Rank | Model | AIC | PPL_min | R² |
|------|-------|-----|---------|-----|
| **1** | **Saturation** | **11.70** | **87.3** | **0.9985** |
| 2 | Exp Decay | 15.30 | 100.1 | 0.9978 |
| 3 | Power Law | 19.37 | N/A | 0.9834 |

**飽和モデルが最も適合**（AIC最小）

### 飽和モデルの式

```
PPL = PPL_min + A × n^(-a)
    = 87.3 + 14990 × n^(-0.847)

PPL_min = 87.3  ← 理論限界値
```

### 予測精度（飽和モデル）

| Samples | Actual | Predicted | Error |
|---------|--------|-----------|-------|
| 200 | 256.0 | 255.5 | -0.2% |
| 400 | 178.7 | 180.8 | +1.2% |
| 800 | 142.4 | 139.3 | -2.2% |
| 1600 | 114.7 | 116.2 | +1.3% |

## prev_context_steps 比較（飽和モデル）

| 構成 | combined_dim | 1600 PPL | PPL_min | PPL_min改善 |
|------|--------------|----------|---------|-------------|
| 2-block (p=0) | 512 | 127.4 | 95.4 | baseline |
| 2-block (p=1) | 1024 | 118.2 | ~85-90 | ~-10% |
| **2-block (p=2)** | **1536** | **114.7** | **87.3** | **-8.5%** |

### 重要な発見

1. **飽和モデルが最適**
   - AIC: 11.70 (最小)
   - R²: 0.9985 (最高)
   - 指数減衰モデルより良いフィット

2. **理論限界値 PPL_min = 87.3**
   - p=0 (95.4) より **8.5%低い**
   - prev_context_stepsを増やすと**理論限界値自体が改善**

3. **prev_context_steps=2 でさらに改善**
   - p=0 → p=2: PPL 127.4 → 114.7 (**-10.0%**)
   - p=1 → p=2: PPL 118.2 → 114.7 (**-3.0%**)

4. **Effective Rankは低下傾向**
   - p=0: ~78% (400/512)
   - p=1: ~73% (745/1024)
   - p=2: ~71% (1089/1536)
   - 次元効率は下がるが、絶対的な有効次元は増加

## Phase 1 収束状況

| Samples | Block 0 | Block 1 |
|---------|---------|---------|
| 200 | 92% (18 iter) | 94% (17 iter) |
| 400 | 92% (17 iter) | 94% (18 iter) |
| 800 | 94% (18 iter) | 92% (17 iter) |
| 1600 | 92% (18 iter) | 90% (17 iter) |

両ブロックとも安定して90%以上の収束率を達成。

## 外挿予測（飽和モデル）

| Samples | 予測 PPL | Δ from PPL_min |
|---------|---------|----------------|
| 3,200 | 103.4 | 16.1 |
| 6,400 | 96.2 | 8.9 |
| 12,800 | 92.3 | 5.0 |
| 25,600 | 90.1 | 2.8 |
| ∞ | 87.3 | 0 |

## 結論

1. **飽和モデルが最も適合**
   - AIC最小、R²最高
   - 理論限界値 PPL_min = 87.3

2. **prev_context_stepsで理論限界値が改善**
   - p=0: PPL_min = 95.4
   - p=2: PPL_min = 87.3 (**-8.5%**)
   - 時系列情報の活用が効果的

3. **コストパフォーマンスの検討**
   - combined_dim: 512 → 1024 → 1536 (+50%ずつ)
   - PPL改善: 7.2% → 3.0% (改善率は逓減)
   - **p=1 または p=2 が推奨**

4. **次のステップ候補**
   - 3-block, 4-block での実験（ブロック数増加）
   - p=2 での3200サンプル実験（飽和モデル検証）
   - context_dim増加（256 → 320, 384）

## 構成比較まとめ（飽和モデル）

| 構成 | combined_dim | 1600 PPL | PPL_min | 特徴 |
|------|--------------|----------|---------|------|
| 1-block (dim=256) | 256 | 134.7 | 132.5 | baseline |
| 2-block (p=0) | 512 | 127.4 | 95.4 | 高ER (78%) |
| 2-block (p=1) | 1024 | 118.2 | ~85-90 | コスパ良 |
| **2-block (p=2)** | **1536** | **114.7** | **87.3** | **最低PPL_min** |

**推奨構成**: 2-block (p=2) が理論限界値最低、2-block (p=1) がコスパ最良
