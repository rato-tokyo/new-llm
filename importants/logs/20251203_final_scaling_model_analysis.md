# Final Scaling Model Analysis

**Date**: 2025-12-03
**Datasets**: context_dim=256, context_dim=320
**Sample sizes**: 100, 200, 400, 800, 1600

## 結論

### ベストモデル: 指数減衰モデル

```
PPL = PPL_min + A × exp(-b × n^c)
```

両方の context_dim で一貫して最良の AIC を達成。

## モデル比較

### 検討した3つのモデル

1. **単純べき乗則**: `PPL = A × n^(-a)`
2. **飽和モデル**: `PPL = PPL_min + A × n^(-a)`
3. **指数減衰**: `PPL = PPL_min + A × exp(-b × n^c)`

### AIC 比較（平均値）

| Model | Average AIC | 順位 |
|-------|-------------|------|
| **指数減衰** | **16.15** | **1位** |
| 飽和モデル | 19.02 | 2位 |
| 単純べき乗則 | 24.11 | 3位 |

### 各データセットでの詳細

#### context_dim=256

| Model | R² | RSS | AIC |
|-------|-----|-----|-----|
| 単純べき乗則 | 0.9847 | 358.88 | 25.37 |
| 飽和モデル | 0.9952 | 111.86 | 21.54 |
| **指数減衰** | **0.9982** | **41.17** | **18.54** |

#### context_dim=320

| Model | R² | RSS | AIC |
|-------|-----|-----|-----|
| 単純べき乗則 | 0.9906 | 216.83 | 22.85 |
| 飽和モデル | 0.9982 | 40.76 | 16.49 |
| **指数減衰** | **0.9993** | **15.79** | **13.75** |

## 指数減衰モデルが優れている理由

### 1. 最高のフィット精度

- dim=256: R² = 0.9982, RSS = 41.17
- dim=320: R² = 0.9993, RSS = 15.79

残差二乗和（RSS）が他のモデルより大幅に小さい。

### 2. AIC（赤池情報量基準）で最良

AIC はパラメータ数のペナルティを含むため、オーバーフィッティングを考慮した評価。
指数減衰は4パラメータにもかかわらず、最良の AIC を達成。

### 3. 収穫逓減を正確にモデル化

指数減衰の `exp(-b × n^c)` 項が、サンプル数増加に伴う改善率の低下を
正確に捉えている。

## フィットされたパラメータ

### 指数減衰モデル

| Parameter | dim=256 | dim=320 | 変化 |
|-----------|---------|---------|------|
| **PPL_min** | **132.5** | **122.8** | **-7.3%** |
| A | 473.4 | 763.1 | +61.2% |
| b | 0.0576 | 0.1995 | +246% |
| c | 0.6007 | 0.4155 | -30.8% |

### 飽和モデル（参考）

| Parameter | dim=256 | dim=320 | 変化 |
|-----------|---------|---------|------|
| PPL_min | 80.5 | 73.6 | -8.6% |
| A | 3167.7 | 2792.7 | -11.8% |
| a | 0.5575 | 0.5261 | -5.6% |

## PPL_min（理論的下限）の解釈

### 指数減衰モデル

- **dim=256**: PPL_min = 132.5
- **dim=320**: PPL_min = 122.8
- **改善**: -7.3%（dim増加25%に対して）

### 飽和モデル

- **dim=256**: PPL_min = 80.5
- **dim=320**: PPL_min = 73.6
- **改善**: -8.6%（dim増加25%に対して）

### 重要な発見: PPL_min は context_dim 増加で減少する

両モデルとも、context_dim を増やすと PPL_min が減少することを示している。

```
指数減衰: 132.5 → 122.8 (-7.3%)
飽和モデル: 80.5 → 73.6 (-8.6%)
```

**これは context_dim 増加に一定の効果があることを示唆**。
ただし、PPL 改善率（-7〜9%）は context_dim 増加率（+25%）よりも小さく、
効率は低い。

## 現在の状況

| Metric | dim=256 | dim=320 |
|--------|---------|---------|
| Best PPL (1600 samples) | 134.7 | 132.6 |
| PPL_min (指数減衰) | 132.5 | 122.8 |
| Gap to PPL_min | 2.2 | 9.8 |

### dim=256 の場合

現在の PPL (134.7) と PPL_min (132.5) の差はわずか **2.2**。
→ **ほぼ理論限界に到達している**

### dim=320 の場合

現在の PPL (132.6) と PPL_min (122.8) の差は **9.8**。
→ **まだ改善余地がある**（約10 PPL分）

## 外挿予測

### 指数減衰モデルによる予測

| Samples | dim=256 | dim=320 |
|---------|---------|---------|
| 3,200 | 132.7 | 125.0 |
| 6,400 | 132.5 | 123.3 |
| 10,000 | 132.5 | 123.0 |
| ∞ | 132.5 | 122.8 |

指数減衰モデルは急速な収束を予測。

### 飽和モデルによる予測（参考）

| Samples | dim=256 | dim=320 |
|---------|---------|---------|
| 3,200 | 115.7 | 113.6 |
| 6,400 | 104.4 | 101.4 |
| 10,000 | 99.1 | 95.6 |
| ∞ | 80.5 | 73.6 |

飽和モデルはより楽観的な予測。

## 2つのモデルの解釈の違い

| 観点 | 指数減衰 | 飽和モデル |
|------|---------|-----------|
| PPL_min | 122-133 | 74-81 |
| 予測の性質 | 保守的 | 楽観的 |
| 収束速度 | 急速 | 緩やか |
| データへのフィット | ★★★ 最良 | ★★ 良好 |

**どちらが正しいか**:
現時点では指数減衰の方がデータによくフィットするが、
より多くのデータ点（3200, 6400 samples）が必要。

## 実用的含意

### 1. アーキテクチャの限界

指数減衰モデルが示唆するのは、現在のアーキテクチャ（1層 ContextBlock + TokenBlock）には
明確な表現力の限界があるということ。

### 2. データ増加の効果は限定的

dim=256 では既に PPL_min に近い（差 2.2）ため、
データを増やしても大きな改善は見込めない。

### 3. context_dim 増加は一定の効果あり

PPL_min が 7-9% 減少することから、context_dim 増加には
一定の効果がある。ただし効率は低い（25%増で7-9%改善）。

### 4. 次のステップ

PPL < 100 を達成するためには:
- **アーキテクチャ改善**: Multi-block、層数増加など
- **学習方法の改善**: Phase 1/2 分離の見直し
- **または**: 飽和モデルが正しいことを祈り、データを増やす

## 検証計画

1. **3200, 6400 samples での実験**
   - 指数減衰 vs 飽和モデルの判別
   - PPL_min の真の値を推定

2. **Multi-block アーキテクチャの検討**
   - カスケード連結による表現力増加
   - PPL_min の改善が見込めるか

## 結論

1. **ベストモデルは指数減衰**（AIC = 16.15）

2. **PPL_min は context_dim 増加で減少**
   - dim=256: 132.5 → dim=320: 122.8 (-7.3%)

3. **現在の PPL は理論限界に近い**
   - 特に dim=256 では差がわずか 2.2

4. **大幅な改善にはアーキテクチャ変更が必要**

## 分析スクリプト

```bash
# 最終モデル分析
python3 scripts/analyze_final_scaling_model.py

# context_dim比較
python3 scripts/analyze_context_dim_comparison.py

# スケーリングモデル比較
python3 scripts/analyze_scaling_models.py
```
