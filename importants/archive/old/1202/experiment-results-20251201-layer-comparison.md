# Layer Configuration Comparison Experiment Results (2025-12-01)

## 実験概要

**目的**: レイヤー構成（num_layers, fnn_num_layers）がモデル性能に与える影響を比較

**環境**:
- GPU: NVIDIA L4 (22.2GB)
- context_dim: 500

**比較構成**:
| Config | num_layers | fnn_num_layers | 説明 |
|--------|------------|----------------|------|
| L1_F1  | 1          | 1              | ベースライン |
| L1_F2  | 1          | 2              | FFN層を深化 |
| L2_F1  | 2          | 1              | レイヤー追加 |

---

## 実験1: 500サンプル（output.txt）

### Phase 1 結果

| Config | Iterations | Conv% | Train ER% | Val ER% | Time |
|--------|------------|-------|-----------|---------|------|
| L1_F1  | 10         | 1%    | 83.8%     | 82.0%   | 35.9s |
| L1_F2  | 10         | 0%    | 78.8%     | 76.3%   | 36.7s |
| L2_F1  | 10         | 27%   | 82.2%     | 81.1%   | 36.7s |

**観察**:
- L2_F1（2レイヤー）は収束が速い（27% vs 0-1%）
- L1_F2（FFN深化）はERが低い（76-79% vs 82-84%）
- 全構成でVal ER早期停止が発動（patience=1チェック）

### Phase 2 結果

| Config | Params | Best Epoch | Val PPL | Val Acc | Time |
|--------|--------|------------|---------|---------|------|
| **L1_F1** | 40.2M | 13 | **205.8** | **22.1%** | 193.5s |
| L1_F2 | 43.4M | 5 | 252.6 | 20.9% | 87.8s |
| L2_F1 | 41.8M | 7 | 227.6 | 21.8% | 116.9s |

**総合時間**: 561.6s (9.4 min)

---

## 実験2: 2000サンプル + 追加10イテレーション（output_plus_10.txt）

### Phase 1 結果

| Config | Iterations | Conv% | Train ER% | Val ER% | Time |
|--------|------------|-------|-----------|---------|------|
| L1_F1  | 20 (+10)   | 33%   | 82.1%     | 82.1%   | 222.0s |
| L1_F2  | 20 (+10)   | 36%   | 75.7%     | 76.4%   | 279.3s |
| L2_F1  | 20 (+10)   | **100%** | 80.2%  | 81.2%   | 252.5s |

**観察**:
- **L2_F1は+10イテレーションで100%収束を達成**
- L1_F1, L1_F2は33-36%で停滞
- +10イテレーション追加により収束率が大幅改善

### Phase 2 結果

| Config | Params | Best Epoch | Val PPL | Val Acc | Time |
|--------|--------|------------|---------|---------|------|
| **L1_F1** | 40.2M | 17 | **189.1** | 22.2% | 1002.1s |
| L1_F2 | 43.4M | 6 | 215.7 | 21.9% | 412.2s |
| L2_F1 | 41.8M | 8 | 192.6 | **22.5%** | 527.2s |

**総合時間**: 2757.3s (46.0 min)

---

## 比較分析

### サンプル数による性能変化

| Config | 500 PPL | 2000 PPL | 改善率 | 500 Acc | 2000 Acc |
|--------|---------|----------|--------|---------|----------|
| L1_F1  | 205.8   | 189.1    | -8.1%  | 22.1%   | 22.2%    |
| L1_F2  | 252.6   | 215.7    | -14.6% | 20.9%   | 21.9%    |
| L2_F1  | 227.6   | 192.6    | -15.4% | 21.8%   | 22.5%    |

### 重要な発見

1. **L1_F1（ベースライン）が最良PPL**
   - 500サンプル: PPL=205.8
   - 2000サンプル: PPL=189.1
   - シンプルな構成が最も安定

2. **L2_F1は収束が極めて速い**
   - 2000サンプルで100%収束（他は33-36%）
   - 最高Acc: 22.5%
   - PPLはL1_F1に次ぐ2位

3. **L1_F2（FFN深化）は性能低下**
   - ERが低い（76%前後）
   - PPLが最も悪い
   - パラメータ増加（+3.2M）に見合う効果なし

4. **+10イテレーション追加の効果**
   - 収束率が大幅改善（特にL2_F1: 27%→100%）
   - Phase 2性能も改善傾向

---

## 結論

### 推奨構成

| 優先度 | 構成 | 理由 |
|--------|------|------|
| 1位 | **L1_F1** | 最良PPL、シンプル、安定 |
| 2位 | L2_F1 | 最高Acc、高速収束、PPLも良好 |
| 非推奨 | L1_F2 | 性能低下、コスト増 |

### Early Stopping戦略への示唆

- **Val ER早期停止後の+10イテレーション追加は有効**
- 特にL2_F1では収束率が27%→100%に改善
- 収束率ベースの停止条件（30%閾値など）が有効

### 次のステップ

1. **収束率ベースのEarly Stopping**で実験（現在実行中）
2. L1_F1とL2_F1の詳細比較
3. より大規模データ（5000サンプル以上）での検証

---

## 生データ

### 500サンプル実験（output.txt）
```
L1_F1: PPL=205.8, Acc=22.1%, ER=81.2%, Time=229.3s
L1_F2: PPL=252.6, Acc=20.9%, ER=76.7%, Time=124.5s
L2_F1: PPL=227.6, Acc=21.8%, ER=80.8%, Time=153.5s
```

### 2000サンプル+10イテレーション実験（output_plus_10.txt）
```
L1_F1: PPL=189.1, Acc=22.2%, ER=80.2%, Time=1224.0s
L1_F2: PPL=215.7, Acc=21.9%, ER=74.0%, Time=691.6s
L2_F1: PPL=192.6, Acc=22.5%, ER=79.2%, Time=779.8s
```

---

*Last Updated: 2025-12-01*
